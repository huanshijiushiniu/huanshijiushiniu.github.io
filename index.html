<!doctype html>



  


<html class="theme-next muse use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.2" />






<meta name="description" content="车到山前必有路">
<meta property="og:type" content="website">
<meta property="og:title" content="郑智文">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="郑智文">
<meta property="og:description" content="车到山前必有路">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="郑智文">
<meta name="twitter:description" content="车到山前必有路">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    }
  };
</script>




  <link rel="canonical" href="http://yoursite.com/"/>


  <title> 郑智文 </title>
</head>

<body itemscope itemtype="//schema.org/WebPage" lang="zh-CN">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="//schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">郑智文</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">iOS dev</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首頁
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            歸檔
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            標籤
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/10/13/AFNetworking 源码分析总结4 NSURLConnection/" itemprop="url">
                  AFNetworking 源码分析总结4
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">發表於</span>
            <time itemprop="dateCreated" datetime="2016-10-13T22:12:31+08:00" content="2016-10-13">
              2016-10-13
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/10/13/AFNetworking 源码分析总结4 NSURLConnection/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/10/13/AFNetworking 源码分析总结4 NSURLConnection/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="AFURLConnectionOperation"><a href="#AFURLConnectionOperation" class="headerlink" title="AFURLConnectionOperation"></a>AFURLConnectionOperation</h2><p>AFURLConnectionOperation继承自NSOpeartion，并且实现了NSURLConnection协议， 主要功能：</p>
<pre><code> 全局网络线程的创建

使用网络线程创建NSURLConnection发送请求，以及实现NSURLConenction代理方法来处理请求的返回数据。

向用户发送请求的各种消息。

控制着请求的生命周期，暂停，恢复，取消。

可以监听处理批量请求的完成度，有多少个请求已经完成。

请求结束之后调用回调用户的业务逻辑
</code></pre><p>AFURLConnectionOperation的组成：</p>
<pre><code> networkRequestThread 全局的网络线程对象，用于所有网络请求对象NSURLConnection的初始化|暂停|取消|。与NSURLConnection相关的逻辑都是由它来完成的。

 NSURLRequest 包含了一个网络请求的封装。

 NSURLResponse 包含了一个网络返回的封装，它是在connection:didReceiveResponse的方法中设置。

 NSData responseData 网络返回的数据，在connectionDidFinishLoading方法中获取。

 NSInputStream 一个用于读取数据的流，是为NSURLRequest httpBody准备的。

 NSOutputStream 一个用户获取网络返回数据的流，在Connection:didReceiveData中将返回的数据一部分一部分的读入,然后在connectionDidFinishLoading方法中将数据填充到responseData中。相当于所有下载的数据会缓存到NSOutputStream中，最后请求结束之后在创建一个完整的responseData。

 completionQueue 队列，用于当请求结束的时候将后续的用户业务逻辑以bock的方法放到该队列中执行。

 completionGroup  组，用于上一条的队列，它是和batchOfRequestOperations:progressBlock:completionBlock:方法联合起来使用的，通过dispatch_group_t派发组，可以监听多个请求的返回结果的处理完成的事件以及最后所有的请求处理完成的事件。

AFNetworkingOperationDidStartNotification，定义用于向用户发送网络请求已经开始的通知。

AFNetworkingOperationDidFinishNotification，定义用于向用户发送网络请求已经结束的通知，在暂停|请求成功|请求失败的时候都会触发，参数是Operation自身。

completionBlock，在NSOperation结束的时候触发，用来处理请求结束之后的业务逻辑，结束指的是请求成功|失败|暂停|取消。

error，用于保存请求中发生的任务错误信息。
</code></pre><h2 id="AFHTTPRequestOperation"><a href="#AFHTTPRequestOperation" class="headerlink" title="AFHTTPRequestOperation"></a>AFHTTPRequestOperation</h2><p>AFHTTPRequestOperation继承自AFURLConnectionOperation,它区别与后者的部分</p>
<pre><code>组成：

          responseSerializationError 用于保存反序列化的过程中发生的错误

          responseSerializer 它是用于请求结果反序列化的对象，具体可以参考源码分析总结2，默认是AFHTTPResponseSerializer。



          responseObject, 它是具体的业务对象的数据(常用的数据形式，还不是业务model层)， 它是通过responseSerializer反序列化而来



功能：

           重写了父类的pause方法，在暂停的时候，对请求对象Request的header做了修改，通过response的ETag字段，设置了请求头If-Range字段。用来实现断点续传的效果，但是仅仅是在app还在运行状态的时候有用。如果app退出则无效果，因为数据是通过NSOutputStream缓存在内存中的，而且If-Range这些信息也仅仅存在于内存对象中。



           重写了error方法，优先返回反序列化错误，后返回父类请求中发生的错误。



           定义了自己的setCompletionBlockWithSuccess:failure:方法，先检查是否有父类的请求错误，再进行反序列化，最后才会回调请求成功的业务逻辑。
</code></pre><h2 id="AFHTTPRequestOperationManager"><a href="#AFHTTPRequestOperationManager" class="headerlink" title="AFHTTPRequestOperationManager"></a>AFHTTPRequestOperationManager</h2><p>AFHTTPRequestOperationManager是用来管理请求的BaseURL以及多个具体的请求，维护着一个请求队列，请求参数序列化的过程中产生的错误由它以回调的方式告知用户。</p>
<pre><code>组成：

          baseURL 用于保存请求的域

          requestSerializer 用于某一个请求的参数序列化对象，它的作用就是生成一个NSMutableURLRequest请求对象，该对象最终用于生成AFHTTPRequestOperation对象，默认是AFHTTPRequestSerializer对象。

          responseSerializer 用于某一个请求的返回数据的反序列化，是由AFHTTPRequestOperationManager保存，用来给AFHTTPRequestOperation设置反序列化对象。

          operationQueue 存放每个请求的队列，放到队列的请求由系统分配线程完成请求。

          reachabilityManager 用于判断网络是否可用的组件
</code></pre>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/10/13/AFNetWorking源码分析总结5——NSURLSession/" itemprop="url">
                  AFNetWorking源码分析总结5——NSURLSession
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">發表於</span>
            <time itemprop="dateCreated" datetime="2016-10-13T22:12:31+08:00" content="2016-10-13">
              2016-10-13
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/10/13/AFNetWorking源码分析总结5——NSURLSession/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/10/13/AFNetWorking源码分析总结5——NSURLSession/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>NSURLSession是iOS 7推出的新一代网络框架，在NSURLConnection的基础上多了一种选择，AFNetworking基于NSURLSession也实现了相应的网络请求API。从功能模块划分，网络可用性，数据的序列化和反序列化以及安全策略这几部分都是一样的，主要是网络请求的管理，请求和返回的处理比前者更加简单，应该说NSURLSession从系统层面实现了NSURLConnection没有实现的部分，比如管理多个请求，直接面向应用层提供上传下载的接口，所以AFNetworking基于NSRULSession实现的网络层更简单，但是功能上没有NSURLConnection那么丰富，比如监听所有任务中完成任务的进度，还有和UIKit的集成。</p>
<h2 id="AFURLSessionManager"><a href="#AFURLSessionManager" class="headerlink" title="AFURLSessionManager"></a>AFURLSessionManager</h2><pre><code>组成：

            session NSURLSession 支持多个以task (网络请求)的管理，是网络层的核心。有 NSURLSessionDelegate, NSURLSessionTaskDelegate, NSURLSessionDataDelegate, NSURLSessionDownloadDelegate 多个代理接口。

            operationQueue 用于初始化NSURLSession的队列，网络请求返回的回调会在该队列中的线程执行。类比使用NSURLConnection的时候，也有一个OperationQueue，功能基本一样，虽然NSURLConnection自己就是异步线程去发起网络请求，但是如果不使用NSOpeartion和OperationQueue，网络回调都将正在主线程中执行，会影响UI操作的流畅性。在NSURLConnection的实现部分，是通过全局的网络线程去执行回调的。这是NSURLConnection和NSURLSession不太一致的地方，后者是系统层就处理了，比NSURLConnection方便不少。

             responseSerializer 用于返回数据的反序列化的对象

             tasks NSURLSession管理的所有网络请求包含重复的，分为一般的api请求,上传请求和下载请求。

             dataTasks 一般的api请求

             uploadTasks 上传请求

             downloadTasks 下载请求

             completionQueue 用户端的回调所在的队列

             completionGroup 用户端回调队列所在的组

             AFURLSessionManagerTaskDelegagate  在AFURLSessionManager内部用于存储task相关数据的业务对象，详细内容下面会单独介绍。

             mutableTaskDelegatesKeyedByTaskIdentifier 可变字典，用于存储task和对应delegate之间的关联。

             剩下的就是在网络请求过程中各种状态的回调block对象了。
</code></pre><h2 id="AFURLSessionManagerTaskDelegate"><a href="#AFURLSessionManagerTaskDelegate" class="headerlink" title="AFURLSessionManagerTaskDelegate"></a>AFURLSessionManagerTaskDelegate</h2><pre><code>在网络请求的各种回调过程中，它用来存储和记录与单个task相关的信息，在网络请求完成之后，将数据返回给用户端。

组成：

             AFURLSessionManager  在AFURLSessionManagerTaskDelegate对象中记录的session对象，一个session对象对应这多个task对象，每个task都有一个与之对应的AFURLSessionManagerTaskDelegate对象。  每一个task在session层面都共享了一些数据，比如序列化对象，回调的队列和组，当一个task完成的时候，都需要从共享的session中获取这些数据来完成业务层的回调逻辑。

             mutableData 存储了当前请求获得的返回的数据信息，最后会反序列化成对象或者是以文件的形式保存下来。

             progress 记录了下载或者上传文件的进度，可以随时通过uploadProgressForTask来获取某个task完成情况，该方法参数为当前task。

             AFURLSessionTaskCompletionHandler 由用户端设置的，task请求完成之后的用户端回调block

             AFURLSessionDownloadTaskDidFinishDownloadingBlock 由用户端设置的，task下载文件完成之后生成目标文件的保存路径的block

             downloadFileURL 由上一个block生成的目标文件保存路径，在下载完成的回调中设置，然后在整个请求完成的回调中以通知的形式返回给用户端
</code></pre><h2 id="AFURLSessionManager_u4E0EAFURLSessionManagerTaskDelegate_u7684_u5173_u7CFB"><a href="#AFURLSessionManager_u4E0EAFURLSessionManagerTaskDelegate_u7684_u5173_u7CFB" class="headerlink" title="AFURLSessionManager与AFURLSessionManagerTaskDelegate的关系"></a>AFURLSessionManager与AFURLSessionManagerTaskDelegate的关系</h2><pre><code>在AFURLSessionManager中实现了大部分NSURLSession的协议，而AFURLSessionManagerTaskDelegate也实现了几个重要的协议，比如数据获取，整个task请求完成，文件下载和上传的进度。不同之处在于AFURLSessionManager是针对所有请求的，而taskDelegate只是针对某次具体的请求的。taskDelegate并没有直接从系统层获得回调，而是所有的回调都会先经过AFURLSessionManager处理，然后再分发给每个具体的taskDelegate，由每个taskDelegate自己存储并记录与当前请求相关的数据和信息。至于AFURLSessionManagerTaskDelegate中会有类似以下的回调的实现逻辑：
</code></pre><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- (void)URLSession:(__unused NSURLSession *)session&#10; &#10;              task:(__unused NSURLSessionTask *)task&#10; &#10;   didSendBodyData:(__unused int64_t)bytesSent&#10; &#10;    totalBytesSent:(int64_t)totalBytesSent&#10; &#10;totalBytesExpectedToSend:(int64_t)totalBytesExpectedToSend&#10; &#10;&#123;&#10; &#10;    self.progress.totalUnitCount = totalBytesExpectedToSend;&#10; &#10;    self.progress.completedUnitCount = totalBytesSent;&#10; &#10;&#125;</span><br></pre></td></tr></table></figure>
<p> task的delegate在这里只获取有用的数据，保存了上传的进度，这样做的目的就是为了保持代码一致性。阅读起来更容理解，相当于代理方法的分发。</p>
<p>sessionManager里通过字典存下了所有的task，而又在具体的session回调中去处理每个task相关的逻辑。</p>
<h2 id="AFHTTPSessionManager"><a href="#AFHTTPSessionManager" class="headerlink" title="AFHTTPSessionManager"></a>AFHTTPSessionManager</h2><pre><code>它集成自AFURLSessionManager，主要功能增加了一些初始化的方法以及对序列化和反序列化阶段的错误检查，还有设置具体的序列化对象。只是在AFURLSessionManager的基础上做了更容易使用的接口的封装。
</code></pre><h2 id="NSURLSession_u548CNSURLConnection"><a href="#NSURLSession_u548CNSURLConnection" class="headerlink" title="NSURLSession和NSURLConnection"></a>NSURLSession和NSURLConnection</h2><pre><code>AFNetworking中NSRULSession的实现上的设计上基本是一致的，AFURLSessionManager相当于AFHTTPRequestOperationManager。而AFURLConnectionOperation类似与NSURLSessionTask。但是对网络回调的实现上是不一致的，前者是依赖NSURLSession处理，然后分发给每个task自己处理。而NSURLConnection是每个请求都是独立处理各自来自系统层的网络回调，这是由于采用了不同的系统网络框架造成的。两种实现都有一个问题，就是如果baseURL是经常变化的，下载某一个素材的时候，这个时候比较好的办法是只使用NSRULConnection中的AFURLConnectionPeration，每次url由自己指定，自己去维护OperationQueue，可能需要自己实现AFHTTPRequestOperationManager的部分。
</code></pre>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/10/13/AFNetworking源码分析3-返回参数反序列化/" itemprop="url">
                  AFNetworking源码分析3-返回数据的反序列化
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">發表於</span>
            <time itemprop="dateCreated" datetime="2016-10-13T22:10:34+08:00" content="2016-10-13">
              2016-10-13
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/10/13/AFNetworking源码分析3-返回参数反序列化/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/10/13/AFNetworking源码分析3-返回参数反序列化/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="u6982_u51B5_uFF1A"><a href="#u6982_u51B5_uFF1A" class="headerlink" title="概况："></a>概况：</h2><p>这部分比较简单，一共有以下几个类：</p>
<ul>
<li>AFHTTPResponseSerializer</li>
<li>AFJSONResponseSerializer  : AFHTTPResponseSerializer</li>
<li>AFXMLParseResponseSerializer : AFHTTPResponseSerializer</li>
<li>AFXMLDocumentResponseSerializer : AFHTTPResponseSerializer</li>
<li>AFPropertyListResponseSerializer : AFHTTPResponseSerializer</li>
<li>AFImageResponseSerializer : AFHTTPResponseSerializer</li>
<li>AFCompoundResponseSerializer : AFHTTPResponseSerializer</li>
</ul>
<h2 id="AFHTTPResponseSerializer"><a href="#AFHTTPResponseSerializer" class="headerlink" title="AFHTTPResponseSerializer"></a>AFHTTPResponseSerializer</h2><p>这个类主要是验证response合法性，是否是有效的response</p>
<p><strong>validateResponse:data:error:</strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- (BOOL)validateResponse:(NSHTTPURLResponse *)response&#10;                    data:(NSData *)data&#10;                   error:(NSError * __autoreleasing *)error&#10; &#10;&#123;&#10;    BOOL responseIsValid = YES;&#10;    NSError *validationError = nil;&#10;    if (response &#38;&#38; [response isKindOfClass:[NSHTTPURLResponse class]]) &#123;&#10;//acceptableContentTypes&#37324;&#23384;&#20648;&#20102;&#24403;&#21069;serializer&#25903;&#25345;&#30340;content-type&#65292;&#21487;&#20197;&#22312;&#19981;&#21516;&#30340;&#23376;&#31867;init&#26041;&#27861;&#20013;&#25351;&#23450;&#12290;&#10;//&#26377;&#26102;&#20505;&#65292;&#36890;&#36807;charlse&#21435;mock&#35831;&#27714;&#30340;response&#65292;&#27809;&#26377;&#36890;&#36807;rewrite&#21151;&#33021;&#37325;&#20889;content-type(&#40664;&#35748;&#26159;text/plain)&#20026;application/json&#23601;&#20250;&#34987;afnetworking&#26174;&#31034;&#35831;&#27714;&#22833;&#36133;&#65292;not accept content-type &#38169;&#35823;&#12290;&#10;        if (self.acceptableContentTypes &#38;&#38; ![self.acceptableContentTypes containsObject:[response MIMEType]]) &#123;&#10; &#10;            if ([data length] &#62; 0 &#38;&#38; [response URL]) &#123;&#10; &#10;                NSMutableDictionary *mutableUserInfo = [@&#123;&#10; &#10;                                                          NSLocalizedDescriptionKey: [NSString stringWithFormat:NSLocalizedStringFromTable(@&#34;Request failed: unacceptable content-type: %@&#34;, @&#34;AFNetworking&#34;, nil), [response MIMEType]],&#10; &#10;                                                          NSURLErrorFailingURLErrorKey:[response URL],&#10; &#10;                                                          AFNetworkingOperationFailingURLResponseErrorKey: response,&#10; &#10;                                                        &#125; mutableCopy];&#10; &#10;                if (data) &#123;&#10; &#10;                    mutableUserInfo[AFNetworkingOperationFailingURLResponseDataErrorKey] = data;&#10; &#10;                &#125;&#10; &#10;                validationError = AFErrorWithUnderlyingError([NSError errorWithDomain:AFURLResponseSerializationErrorDomain code:NSURLErrorCannotDecodeContentData userInfo:mutableUserInfo], validationError);&#10; &#10;            &#125;&#10; &#10;            responseIsValid = NO;&#10;        &#125;&#10;//acceptableStatusCodes&#23384;&#20648;&#20102;&#24403;&#21069;serializer&#25903;&#25345;&#30340;&#36820;&#22238;&#30721;&#65292;&#37324;&#38754;&#30340;&#20540;&#26159;&#22312;AFHTTPResponseSerializer&#22522;&#31867;&#10;&#35843;&#29992;init&#26041;&#27861;&#20013;&#25351;&#23450;&#30340;&#12290;&#10;        if (self.acceptableStatusCodes &#38;&#38; ![self.acceptableStatusCodes containsIndex:(NSUInteger)response.statusCode] &#38;&#38; [response URL]) &#123;&#10; &#10;            NSMutableDictionary *mutableUserInfo = [@&#123;&#10; &#10;                                               NSLocalizedDescriptionKey: [NSString stringWithFormat:NSLocalizedStringFromTable(@&#34;Request failed: %@ (%ld)&#34;, @&#34;AFNetworking&#34;, nil), [NSHTTPURLResponse localizedStringForStatusCode:response.statusCode], (long)response.statusCode],&#10; &#10;                                               NSURLErrorFailingURLErrorKey:[response URL],&#10; &#10;                                               AFNetworkingOperationFailingURLResponseErrorKey: response,&#10; &#10;                                       &#125; mutableCopy];&#10;            if (data) &#123;&#10; &#10;                mutableUserInfo[AFNetworkingOperationFailingURLResponseDataErrorKey] = data;&#10; &#10;            &#125;&#10; &#10;            validationError = AFErrorWithUnderlyingError([NSError errorWithDomain:AFURLResponseSerializationErrorDomain code:NSURLErrorBadServerResponse userInfo:mutableUserInfo], validationError);&#10;            responseIsValid = NO;&#10;        &#125;&#10;    &#125;&#10;    if (error &#38;&#38; !responseIsValid) &#123;&#10; &#10;        *error = validationError;&#10; &#10;    &#125;&#10;    return responseIsValid;&#10;&#125;</span><br></pre></td></tr></table></figure>
<p><strong>AFHTTPResponseSerializer</strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">//&#21482;&#20570;&#20102;response&#30340;&#39564;&#35777;&#36923;&#36753;&#65292;&#20855;&#20307;&#30340;&#21453;&#24207;&#21015;&#21270;&#22312;&#21508;&#20010;&#23376;&#31867;&#20013;&#23454;&#29616;&#12290;&#10;//&#25152;&#26377;&#30340;serializer&#37117;&#35201;&#23454;&#29616;&#36825;&#20010;&#26041;&#27861;,&#22312;&#32593;&#32476;&#35831;&#27714;&#25104;&#21151;&#36820;&#22238;&#25968;&#25454;&#20043;&#21518;&#65292;AFNetworking&#23601;&#20250;&#35843;&#29992;serializer&#36825;&#20010;&#26041;&#27861;&#26469;&#21453;&#24207;&#21015;&#21270;&#12290;&#10;- (id)responseObjectForResponse:(NSURLResponse *)response&#10;                           data:(NSData *)data&#10;                          error:(NSError *__autoreleasing *)error&#10;&#123;&#10;    [self validateResponse:(NSHTTPURLResponse *)response data:data error:error];&#10;    return data;&#10;&#125;</span><br></pre></td></tr></table></figure>
<h2 id="AFJSONResponseSerializer"><a href="#AFJSONResponseSerializer" class="headerlink" title="AFJSONResponseSerializer"></a>AFJSONResponseSerializer</h2><p><strong>responseObjectForResponse:data:error</strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- (id)responseObjectForResponse:(NSURLResponse *)response&#10;                           data:(NSData *)data&#10;                          error:(NSError *__autoreleasing *)error&#10;&#123;&#10; &#10;    if (![self validateResponse:(NSHTTPURLResponse *)response data:data error:error]) &#123;&#10; &#10;        if (!error || AFErrorOrUnderlyingErrorHasCodeInDomain(*error, NSURLErrorCannotDecodeContentData, AFURLResponseSerializationErrorDomain)) &#123;&#10; &#10;            return nil;&#10; &#10;        &#125;&#10; &#10;    &#125;&#10; &#10;    // Workaround for behavior of Rails to return a single space for `head :ok` (a workaround for a bug in Safari), which is not interpreted as valid input by NSJSONSerialization.&#10; &#10;    // See https://github.com/rails/rails/issues/1742&#10; &#10;    NSStringEncoding stringEncoding = self.stringEncoding;&#10; &#10;    if (response.textEncodingName) &#123;&#10; &#10;        CFStringEncoding encoding = CFStringConvertIANACharSetNameToEncoding((CFStringRef)response.textEncodingName);&#10; &#10;        if (encoding != kCFStringEncodingInvalidId) &#123;&#10;            stringEncoding = CFStringConvertEncodingToNSStringEncoding(encoding);&#10;        &#125;&#10;    &#125;&#10; &#10;    id responseObject = nil;&#10; &#10;    NSError *serializationError = nil;&#10; &#10;    @autoreleasepool &#123;&#10; &#10;        NSString *responseString = [[NSString alloc] initWithData:data encoding:stringEncoding];&#10; &#10;        if (responseString &#38;&#38; ![responseString isEqualToString:@&#34; &#34;]) &#123;&#10; &#10;            // Workaround for a bug in NSJSONSerialization when Unicode character escape codes are used instead of the actual character&#10; &#10;            // See http://stackoverflow.com/a/12843465/157142&#10; &#10;            data = [responseString dataUsingEncoding:NSUTF8StringEncoding];&#10; &#10;            if (data) &#123;&#10; &#10;                if ([data length] &#62; 0) &#123;&#10;                    responseObject = [NSJSONSerialization JSONObjectWithData:data options:self.readingOptions error:&#38;serializationError];&#10;                &#125; else &#123;&#10;                    return nil;&#10;                &#125;&#10; &#10;            &#125; else &#123;&#10; &#10;                NSDictionary *userInfo = @&#123;&#10; &#10;                                           NSLocalizedDescriptionKey: NSLocalizedStringFromTable(@&#34;Data failed decoding as a UTF-8 string&#34;, @&#34;AFNetworking&#34;, nil),&#10; &#10;                                           NSLocalizedFailureReasonErrorKey: [NSString stringWithFormat:NSLocalizedStringFromTable(@&#34;Could not decode string: %@&#34;, @&#34;AFNetworking&#34;, nil), responseString]&#10; &#10;                                           &#125;;&#10;                serializationError = [NSError errorWithDomain:AFURLResponseSerializationErrorDomain code:NSURLErrorCannotDecodeContentData userInfo:userInfo];&#10;            &#125;&#10;        &#125;&#10;    &#125;&#10;//1.removesKeysWithNullValues&#34920;&#31034;&#24403;&#36820;&#22238;&#30340;&#25968;&#25454;dictionary&#30340;value&#20026;NSNULL&#30340;&#24773;&#20917;&#30340;&#26102;&#20505;&#65292;&#26159;&#21542;&#31227;&#38500;&#23545;&#24212;&#38190;&#20540;&#23545;&#12290;&#19981;&#22788;&#29702;&#20250;&#23548;&#33268;&#21069;&#31471;crash&#65292;&#22914;&#26524;&#19981;&#35774;&#32622;&#36825;&#20010;&#23646;&#24615;&#65292;&#40664;&#35748;&#26159;false&#10;//2.self.readingOptions&#21487;&#20197;&#26681;&#25454;&#38656;&#27714;&#29992;&#26469;&#35774;&#32622;&#26368;&#21518;&#21453;&#24207;&#21015;&#21270;&#20986;&#23383;&#20856;&#26159;&#21542;&#26410;&#21487;&#21464;&#31867;&#22411;(NSJSONReadingMutableContainers)&#65292;&#40664;&#35748;&#26159;&#19981;&#21487;&#21464;&#31867;&#22411;&#10;    if (self.removesKeysWithNullValues &#38;&#38; responseObject) &#123;&#10;        responseObject = AFJSONObjectByRemovingKeysWithNullValues(responseObject, self.readingOptions);&#10;    &#125;&#10;    if (error) &#123;&#10;        *error = AFErrorWithUnderlyingError(serializationError, *error);&#10;    &#125;&#10;    return responseObject;&#10;&#125;</span><br></pre></td></tr></table></figure>
<h2 id="AFCompoundResponseSerializer"><a href="#AFCompoundResponseSerializer" class="headerlink" title="AFCompoundResponseSerializer"></a>AFCompoundResponseSerializer</h2><p><strong>responseObjectForResponse:data:error:</strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">//&#36825;&#20010;&#31867;&#20027;&#35201;&#26159;&#21487;&#20197;&#21512;&#24182;&#22810;&#20013;Serializer&#30340;&#21151;&#33021;&#65292;&#23384;&#20648;&#22312;self.responseSerializers&#38598;&#21512;&#20013;&#12290;&#10;- (id)responseObjectForResponse:(NSURLResponse *)response&#10;                           data:(NSData *)data&#10;                          error:(NSError *__autoreleasing *)error&#10; &#10;&#123;&#10;//&#36825;&#37324;&#27809;&#26377;&#35843;&#29992;validateResponse&#26041;&#27861;&#65292;&#22240;&#20026;&#36825;&#20010;&#31867;&#22788;&#29702;&#30340;&#19981;&#26159;&#26576;&#19968;&#20010;&#20855;&#20307;&#30340;response&#31867;&#22411;&#10;    for (id &#60;AFURLResponseSerialization&#62; serializer in self.responseSerializers) &#123;&#10;        if (![serializer isKindOfClass:[AFHTTPResponseSerializer class]]) &#123;&#10;            continue;&#10;        &#125;&#10; &#10;        NSError *serializerError = nil;&#10;        id responseObject = [serializer responseObjectForResponse:response data:data error:&#38;serializerError];&#10;        if (responseObject) &#123;&#10;            if (error) &#123;&#10;                *error = AFErrorWithUnderlyingError(serializerError, *error);&#10;            &#125;&#10; &#10;            return responseObject;&#10;        &#125;&#10; &#10;    &#125;&#10;    return [super responseObjectForResponse:response data:data error:error];&#10;&#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/10/13/AFNetworking源码分析2-请求参数序列化/" itemprop="url">
                  AFNetworking源码解析2-请求参数序列化
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">發表於</span>
            <time itemprop="dateCreated" datetime="2016-10-13T20:00:00+08:00" content="2016-10-13">
              2016-10-13
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/10/13/AFNetworking源码分析2-请求参数序列化/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/10/13/AFNetworking源码分析2-请求参数序列化/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="u6982_u51B5_u4ECB_u7ECD_uFF1A"><a href="#u6982_u51B5_u4ECB_u7ECD_uFF1A" class="headerlink" title="概况介绍："></a>概况介绍：</h2><p>这篇主要介绍AFNetworking中请求参数序列化的部分,具体代码在AFURLRequestSerialization中。AFURLRequestSerialization包含四部分:</p>
<ul>
<li>AFHTTPRequestSerializaiton</li>
<li>AFJSONRequestSerializer</li>
<li>AFPropertyListRequestSerializer</li>
</ul>
<p>AFHTTPRequestSerialization主要是设置http请求头,设置超时时间,BA认证，处理用户名密码登陆等等。主要功能分3大块：</p>
<ol>
<li>处理所有的GET,HEAD,DELETE请求</li>
<li>处理content-type是application/x-www-form-urlencoded类型的POST请求</li>
<li>处理content-type是multipart/form-data类型的POST请求，请求的构建是通过AFStreamingMultipartFormData对象实现的。</li>
</ol>
<p>AFJSONRequestSerializer继承自AFHTTPRequestSerialization类，使用NSJSONSerialization序列化json格式(application/json)的参数，将一个Dictionary对象转化成NSData，它只处理POST请求。</p>
<p>AFPropertyListRequestSerializer也继承了AFHTTPRequestSerialization类，使用NSPropertyListSerialization对象来序列化xml格式(application/x-plist)的参数，它也只处理POST请求。</p>
<p>综上所述，AFHTTPRequestSerialization是最重要也是最复杂的部分，源码也主要针对这部分做分析。</p>
<h2 id="u6E90_u7801_u5206_u6790_uFF1A"><a href="#u6E90_u7801_u5206_u6790_uFF1A" class="headerlink" title="源码分析："></a>源码分析：</h2><h3 id="u53C2_u6570_u5E8F_u5217_u5316_u548C_u7F16_u7801"><a href="#u53C2_u6570_u5E8F_u5217_u5316_u548C_u7F16_u7801" class="headerlink" title="参数序列化和编码"></a>参数序列化和编码</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- (NSURLRequest *)requestBySerializingRequest:(NSURLRequest *)request&#10; &#10;                               withParameters:(id)parameters&#10; &#10;                                        error:(NSError *__autoreleasing *)error&#10; &#10;&#123;&#10; &#10;    NSParameterAssert(request);&#10; &#10;    NSMutableURLRequest *mutableRequest = [request mutableCopy];&#10;//&#35774;&#32622;http&#35831;&#27714;&#22836;&#10;    [self.HTTPRequestHeaders enumerateKeysAndObjectsUsingBlock:^(id field, id value, BOOL * __unused stop) &#123;&#10; &#10;        if (![request valueForHTTPHeaderField:field]) &#123;&#10; &#10;            [mutableRequest setValue:value forHTTPHeaderField:field];&#10;        &#125;&#10;    &#125;];&#10;//&#24207;&#21015;&#21270;&#21442;&#25968;&#10;    if (parameters) &#123;&#10; &#10;        NSString *query = nil;&#10;//queryStringSerilization&#26159;&#19968;&#20010;block&#65292;&#20027;&#35201;&#26159;&#29992;&#26469;&#33258;&#23450;&#20041;&#21442;&#25968;&#24207;&#21015;&#21270;&#30340;&#36923;&#36753;&#65292;&#36820;&#22238;&#19968;&#20010;&#24207;&#21015;&#21270;&#23436;&#25104;&#30340;&#32467;&#26524;&#10;        if (self.queryStringSerialization) &#123;&#10; &#10;            NSError *serializationError;&#10; &#10;            query = self.queryStringSerialization(request, parameters, &#38;serializationError);&#10; &#10;            if (serializationError) &#123;&#10; &#10;                if (error) &#123;&#10; &#10;                    *error = serializationError;&#10; &#10;                &#125;&#10; &#10;                return nil;&#10;            &#125;&#10;        &#125; else &#123;&#10; &#10;            switch (self.queryStringSerializationStyle) &#123;&#10;//&#20351;&#29992;AFNetworking&#40664;&#35748;&#30340;&#26684;&#24335;&#24207;&#21015;&#21270;&#65292;a=1&#38;b=2&#36825;&#31181;&#10;                case AFHTTPRequestQueryStringDefaultStyle:&#10;//&#36825;&#37324;parameters&#26159;&#19968;&#20010;dictionary&#23545;&#35937;,stringEncoding&#26159;&#32473;httpBody&#35774;&#32622;data&#30340;&#26102;&#20505;&#23383;&#31526;&#20018;&#30340;&#32534;&#30721;&#26684;&#24335;&#10;                    query = AFQueryStringFromParametersWithEncoding(parameters, self.stringEncoding);&#10; &#10;                    break;&#10; &#10;            &#125;&#10; &#10;        &#125;&#10;//HTTPMethodsEncodingParametersInURI&#23450;&#20041;&#20102;GET,DELETE,HEAD3&#31181;&#26041;&#27861;&#10;        if ([self.HTTPMethodsEncodingParametersInURI containsObject:[[request HTTPMethod] uppercaseString]]) &#123;&#10; &#10;            mutableRequest.URL = [NSURL URLWithString:[[mutableRequest.URL absoluteString] stringByAppendingFormat:mutableRequest.URL.query ? @&#34;&#38;%@&#34; : @&#34;?%@&#34;, query]];&#10; &#10;        &#125; else &#123;&#10;//POST&#10;            if (![mutableRequest valueForHTTPHeaderField:@&#34;Content-Type&#34;]) &#123;&#10; &#10;                [mutableRequest setValue:@&#34;application/x-www-form-urlencoded&#34; forHTTPHeaderField:@&#34;Content-Type&#34;];&#10; &#10;            &#125;&#10;//setHTTPBody&#25509;&#21463;&#19968;&#20010;NSData&#30340;&#21442;&#25968;,&#23558;query&#36716;&#21270;&#25104;NSData&#10;            [mutableRequest setHTTPBody:[query dataUsingEncoding:self.stringEncoding]];&#10;        &#125;&#10;    &#125;&#10; &#10;    return mutableRequest;&#10;&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">//&#29992;&#20110;AFURLRequestSerialization&#20869;&#37096;&#35843;&#29992;&#30340;&#26041;&#27861;&#10;static NSString * AFQueryStringFromParametersWithEncoding(NSDictionary *parameters, NSStringEncoding stringEncoding) &#123;&#10; &#10;    NSMutableArray *mutablePairs = [NSMutableArray array];&#10;//AFQueryStringPair&#26159;&#23553;&#35013;&#30340;&#38190;&#20540;&#23545;&#23545;&#35937;,&#20027;&#35201;&#26159;&#23558;dictionary&#20013;&#30340;&#38190;&#20540;&#23545;&#36716;&#21270;&#25104;query string&#24418;&#24335;&#65292;&#21253;&#25324;&#19968;&#20123;&#29305;&#27530;&#23383;&#31526;&#30340;&#32534;&#30721;&#10;//AFQueryStringPairsFromDictionary&#23558;dictionary&#36716;&#21270;&#25104;AFQueryStringPair&#38598;&#21512;&#10;    for (AFQueryStringPair *pair in AFQueryStringPairsFromDictionary(parameters)) &#123;&#10; &#10;        [mutablePairs addObject:[pair URLEncodedStringValueWithEncoding:stringEncoding]];&#10; &#10;    &#125;&#10;    return [mutablePairs componentsJoinedByString:@&#34;&#38;&#34;];&#10; &#10;&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- (NSString *)URLEncodedStringValueWithEncoding:(NSStringEncoding)stringEncoding &#123;&#10;//&#30896;&#21040;nil&#25110;&#32773;NSNULL&#36793;&#30028;&#20540;&#30340;&#22788;&#29702;&#10;    if (!self.value || [self.value isEqual:[NSNull null]]) &#123;&#10;        return AFPercentEscapedQueryStringKeyFromStringWithEncoding([self.field description], stringEncoding);&#10;    &#125; else &#123;&#10;        return [NSString stringWithFormat:@&#34;%@=%@&#34;, AFPercentEscapedQueryStringKeyFromStringWithEncoding([self.field description], stringEncoding), AFPercentEscapedQueryStringValueFromStringWithEncoding([self.value description], stringEncoding)];&#10;    &#125;&#10;&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">//&#20027;&#35201;&#35843;&#29992;foundation&#20989;&#25968;CFURLCreateStringByAddingPercentEscapes&#65292;&#23427;&#20027;&#35201;&#26159;&#23558;querystring&#20013;&#30340;&#29305;&#27530;&#23383;&#31526;(&#38;,?)&#32534;&#30721;&#25104;&#8220;%+ASCII&#8221; &#24418;&#24335;&#12290;&#26681;&#25454;&#25991;&#26723;&#65292;&#24314;&#35758;&#20351;&#29992;NSString stringByAddingPercentEncodingWithAllowedCharacters:]&#26041;&#27861;&#65292;&#36825;&#20010;&#26041;&#27861;&#20351;&#29992;UTF-8 encoding&#12290;&#10;static NSString * AFPercentEscapedQueryStringValueFromStringWithEncoding(NSString *string, NSStringEncoding encoding) &#123;&#10;    return (__bridge_transfer  NSString *)CFURLCreateStringByAddingPercentEscapes(kCFAllocatorDefault, (__bridge CFStringRef)string, NULL, (__bridge CFStringRef)kAFCharactersToBeEscapedInQueryString, CFStringConvertNSStringEncodingToEncoding(encoding));&#10;&#125;</span><br></pre></td></tr></table></figure>
<h3 id="AFStreamingMutipartFormData"><a href="#AFStreamingMutipartFormData" class="headerlink" title="AFStreamingMutipartFormData"></a>AFStreamingMutipartFormData</h3><p>先看一个mutipart/form-data格式的请求</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">POST http://www.example.com HTTP/1.1&#10;Content-Type:multipart/form-data; boundary=----WebKitFormBoundaryrGKCBY7qhFd3TrwA&#10; &#10;------WebKitFormBoundaryrGKCBY7qhFd3TrwA&#10;Content-Disposition: form-data; name=&#34;text&#34;&#10; &#10;title&#10;------WebKitFormBoundaryrGKCBY7qhFd3TrwA&#10;Content-Disposition: form-data; name=&#34;file&#34;; filename=&#34;chrome.png&#34;&#10;Content-Type: image/png&#10; &#10;PNG ... content of chrome.png ...&#10;------WebKitFormBoundaryrGKCBY7qhFd3TrwA--</span><br></pre></td></tr></table></figure>
<ol>
<li>它的Content-Type包含两部分，第一部分是multipart/form-data,第二部分是boundary, boundary一般是随机生成的，保持唯一即可。上面还需要有content-length，图里面没有。</li>
<li>每个参数的部分都有content-disposition，并且以–boundary开头,最后一个参数以–boundary–结尾。</li>
</ol>
<p>AFNetworking通过AFStreamingMutipartFormData处理multipart/form-data格式的POST请求,它通过NSInputStream来构建http请求的body。每个参数的信息封装到了AFHTTPBodyPart中，所有的参数信息封装在AFMulipartBodyStream中。AFHTTPBodyPart中有NSInputStream对象用来将每个参数的写入到body，而AFMutipartBodyStream继承子NSInputStream处理所有参数的写入到body。其结构示意如下：</p>
<p><img src="http://7xqgnx.com1.z0.glb.clouddn.com/AFNetworkingArch.png" alt="AFNetworkingArch"></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">//&#22788;&#29702;multilpart/form-data(POST)&#35831;&#27714;&#10;- (NSMutableURLRequest *)multipartFormRequestWithMethod:(NSString *)method&#10; &#10;                                              URLString:(NSString *)URLString&#10; &#10;                                             parameters:(NSDictionary *)parameters&#10; &#10;                              constructingBodyWithBlock:(void (^)(id &#60;AFMultipartFormData&#62; formData))block&#10; &#10;                                                  error:(NSError *__autoreleasing *)error&#10; &#10;&#123;&#10;    NSParameterAssert(method);&#10; &#10;    NSParameterAssert(![method isEqualToString:@&#34;GET&#34;] &#38;&#38; ![method isEqualToString:@&#34;HEAD&#34;]);&#10;//&#36825;&#37324;parameters&#20256;&#30340;&#26159;nil&#65292;&#22240;&#20026;&#24403;&#21069;&#26684;&#24335;(mutilpart/form-data)&#38656;&#35201;&#30001;AFStreamingMulitpartFormData&#21435;&#26500;&#24314;&#21442;&#25968;&#12290;&#10;    NSMutableURLRequest *mutableRequest = [self requestWithMethod:method URLString:URLString parameters:nil error:error];&#10; &#10;    __block AFStreamingMultipartFormData *formData = [[AFStreamingMultipartFormData alloc] initWithURLRequest:mutableRequest stringEncoding:NSUTF8StringEncoding];&#10; &#10;    if (parameters) &#123;&#10; &#10;        for (AFQueryStringPair *pair in AFQueryStringPairsFromDictionary(parameters)) &#123;&#10;//&#23545;&#20110;dictionary&#30340;&#21442;&#25968;&#65292;&#30452;&#25509;&#23558;&#23427;&#30340;&#20540;&#36716;&#25104;NSData&#22788;&#29702;&#65292;&#10;            NSData *data = nil;&#10; &#10;            if ([pair.value isKindOfClass:[NSData class]]) &#123;&#10; &#10;                data = pair.value;&#10; &#10;            &#125; else if ([pair.value isEqual:[NSNull null]]) &#123;&#10; &#10;                data = [NSData data];&#10; &#10;            &#125; else &#123;&#10; &#10;                data = [[pair.value description] dataUsingEncoding:self.stringEncoding];&#10; &#10;            &#125;&#10; &#10;            if (data) &#123;&#10;//AFStreamingMultipartFormData&#23545;&#35937;&#30340;appendPartWithFormData&#23558;&#38190;&#20540;&#23545;&#36716;&#21270;&#25104;AFHTTPBodyPart&#24182;&#19988;&#25918;&#21040;AFMultipartBodyStream&#38598;&#21512;&#20013;&#12290;&#10;                [formData appendPartWithFormData:data name:[pair.field description]];&#10; &#10;            &#125;&#10; &#10;        &#125;&#10; &#10;    &#125;&#10; &#10;    if (block) &#123;&#10;//&#24403;&#21069;block&#29992;&#26469;&#22788;&#29702;&#38750;dictionary&#30340;&#24773;&#20917;&#65292;&#27604;&#22914;&#21442;&#25968;&#21487;&#33021;&#26159;&#19968;&#20010;NSURL,&#25110;&#32773;&#30452;&#25509;&#23601;&#26159;&#19968;&#20010;NSInputStream&#12290;&#10;        block(formData);&#10; &#10;    &#125;&#10;//AFStreamingMultipartFormData&#30340;requestByFinalizingMultipartFormData&#20027;&#35201;&#26159;&#35774;&#32622;content-Type&#21644;content-Length&#20197;&#21450;boundary&#10;    return [formData requestByFinalizingMultipartFormData];&#10; &#10;&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- (NSMutableURLRequest *)requestByFinalizingMultipartFormData &#123;&#10; &#10;    if ([self.bodyStream isEmpty]) &#123;&#10; &#10;        return self.request;&#10; &#10;    &#125;&#10; &#10;    // &#35774;&#32622;boundary&#10; &#10;    [self.bodyStream setInitialAndFinalBoundaries];&#10; &#10;//&#23558;AFStreamingMultipartFormData&#30340;AFMultipartBodyStream&#35774;&#32622;&#21040;http body stream&#19978;&#10;    [self.request setHTTPBodyStream:self.bodyStream];&#10; &#10;    [self.request setValue:[NSString stringWithFormat:@&#34;multipart/form-data; boundary=%@&#34;, self.boundary] forHTTPHeaderField:@&#34;Content-Type&#34;];&#10; &#10;    [self.request setValue:[NSString stringWithFormat:@&#34;%llu&#34;, [self.bodyStream contentLength]] forHTTPHeaderField:@&#34;Content-Length&#34;];&#10; &#10;    return self.request;&#10; &#10;&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- (void)setInitialAndFinalBoundaries &#123;&#10; &#10;    if ([self.HTTPBodyParts count] &#62; 0) &#123;&#10; &#10;        for (AFHTTPBodyPart *bodyPart in self.HTTPBodyParts) &#123;&#10; &#10;            bodyPart.hasInitialBoundary = NO;&#10; &#10;            bodyPart.hasFinalBoundary = NO;&#10; &#10;        &#125;&#10;//&#35774;&#32622;boundary&#30340;&#22836;&#10;        [[self.HTTPBodyParts objectAtIndex:0] setHasInitialBoundary:YES];&#10;//&#35774;&#32622;boundary&#30340;&#23614;&#10;        [[self.HTTPBodyParts lastObject] setHasFinalBoundary:YES];&#10; &#10;    &#125;&#10; &#10;&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">//&#20027;&#35201;&#26159;&#35774;&#32622;&#27599;&#20010;&#21442;&#25968;&#37096;&#20998;&#30340;content-disposition&#10;- (void)appendPartWithFormData:(NSData *)data&#10;                          name:(NSString *)name&#10; &#10;&#123;&#10;    NSParameterAssert(name);&#10; &#10;    NSMutableDictionary *mutableHeaders = [NSMutableDictionary dictionary];&#10; &#10;    [mutableHeaders setValue:[NSString stringWithFormat:@&#34;form-data; name=\&#34;%@\&#34;&#34;, name] forKey:@&#34;Content-Disposition&#34;];&#10; &#10;    [self appendPartWithHeaders:mutableHeaders body:data];&#10; &#10;&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">//&#26500;&#24314;AFHTTPBodyPart&#23545;&#35937;,&#36825;&#31181;&#24773;&#20917;&#19979;&#65292;AFHTTPBody&#23545;&#35937;&#30340;body&#37117;&#26159;nsdata&#31867;&#22411;&#10;- (void)appendPartWithHeaders:(NSDictionary *)headers&#10;                         body:(NSData *)body&#10; &#10;&#123;&#10;    NSParameterAssert(body);&#10; &#10;    AFHTTPBodyPart *bodyPart = [[AFHTTPBodyPart alloc] init];&#10; &#10;    bodyPart.stringEncoding = self.stringEncoding;&#10; &#10;    bodyPart.headers = headers;&#10; &#10;    bodyPart.boundary = self.boundary;&#10; &#10;    bodyPart.bodyContentLength = [body length];&#10; &#10;    bodyPart.body = body;&#10; &#10;    [self.bodyStream appendHTTPBodyPart:bodyPart];&#10; &#10;&#125;</span><br></pre></td></tr></table></figure>
<p>除了NSData，还可以传入NSInputStream,NSURL去构建AFHTTPBodyPart对象，过程和NSData类似，设置Content-disposition和Content-Type，再通过data去构建AFHTTPBodyPart。</p>
<h3 id="AFMultipartBodyStream"><a href="#AFMultipartBodyStream" class="headerlink" title="AFMultipartBodyStream"></a>AFMultipartBodyStream</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">//AFStreamingMutipartFormData&#23558;AFMultipartBodyStream&#35774;&#32622;&#21040;NSUrlRequest&#30340;httpbodystream&#20043;&#21518;&#65292;foundation&#20250;&#33258;&#21160;&#35843;&#29992;read:maxLength:&#26041;&#27861;&#65292;&#25913;&#26041;&#27861;&#23454;&#29616;&#20013;&#36941;&#21382;&#20043;&#21069;&#26500;&#24314;&#30340;&#25152;&#26377;AFHTTPBodyPart&#23545;&#35937;&#65292;&#20998;&#21035;&#35843;&#29992;&#23427;&#20204;&#30340;read:maxLength:&#26041;&#27861;&#26469;&#33719;&#21462;&#25968;&#25454;&#12290;&#10;- (NSInteger)read:(uint8_t *)buffer&#10; &#10;        maxLength:(NSUInteger)length&#10; &#10;&#123;&#10;    if ([self streamStatus] == NSStreamStatusClosed) &#123;&#10; &#10;        return 0;&#10; &#10;    &#125;&#10; &#10;    NSInteger totalNumberOfBytesRead = 0;&#10; &#10;#pragma clang diagnostic push&#10; &#10;#pragma clang diagnostic ignored &#34;-Wgnu&#34;&#10; &#10;    while ((NSUInteger)totalNumberOfBytesRead &#60; MIN(length, self.numberOfBytesInPacket)) &#123;&#10; &#10;        if (!self.currentHTTPBodyPart || ![self.currentHTTPBodyPart hasBytesAvailable]) &#123;&#10; &#10;            if (!(self.currentHTTPBodyPart = [self.HTTPBodyPartEnumerator nextObject])) &#123;&#10; &#10;                break;&#10; &#10;            &#125;&#10; &#10;        &#125; else &#123;&#10; &#10;            NSUInteger maxLength = length - (NSUInteger)totalNumberOfBytesRead;&#10; &#10;            NSInteger numberOfBytesRead = [self.currentHTTPBodyPart read:&#38;buffer[totalNumberOfBytesRead] maxLength:maxLength];&#10; &#10;            if (numberOfBytesRead == -1) &#123;&#10; &#10;                self.streamError = self.currentHTTPBodyPart.inputStream.streamError;&#10; &#10;                break;&#10; &#10;            &#125; else &#123;&#10; &#10;                totalNumberOfBytesRead += numberOfBytesRead;&#10; &#10;                if (self.delay &#62; 0.0f) &#123;&#10; &#10;                    [NSThread sleepForTimeInterval:self.delay];&#10; &#10;                &#125;&#10; &#10;            &#125;&#10; &#10;        &#125;&#10; &#10;    &#125;&#10;    return totalNumberOfBytesRead;&#10; &#10;&#125;</span><br></pre></td></tr></table></figure>
<h3 id="AFHTTPBodyPart"><a href="#AFHTTPBodyPart" class="headerlink" title="AFHTTPBodyPart"></a>AFHTTPBodyPart</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">//&#26681;&#25454;body&#31867;&#22411;&#29983;&#25104;&#23545;&#24212;&#30340;inputStream&#10;- (NSInputStream *)inputStream &#123;&#10; &#10;    if (!_inputStream) &#123;&#10; &#10;        if ([self.body isKindOfClass:[NSData class]]) &#123;&#10; &#10;            _inputStream = [NSInputStream inputStreamWithData:self.body];&#10; &#10;        &#125; else if ([self.body isKindOfClass:[NSURL class]]) &#123;&#10; &#10;            _inputStream = [NSInputStream inputStreamWithURL:self.body];&#10; &#10;        &#125; else if ([self.body isKindOfClass:[NSInputStream class]]) &#123;&#10; &#10;            _inputStream = self.body;&#10; &#10;        &#125; else &#123;&#10;            _inputStream = [NSInputStream inputStreamWithData:[NSData data]];&#10;        &#125;&#10;    &#125;&#10; &#10;    return _inputStream;&#10;&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- (NSInteger)read:(uint8_t *)buffer&#10; &#10;        maxLength:(NSUInteger)length&#10; &#10;&#123;&#10; &#10;    NSInteger totalNumberOfBytesRead = 0;&#10;    if (_phase == AFEncapsulationBoundaryPhase) &#123;&#10;//boundary&#37096;&#20998;&#65292;&#36716;&#25104;NSData&#10;        NSData *encapsulationBoundaryData = [([self hasInitialBoundary] ? AFMultipartFormInitialBoundary(self.boundary) : AFMultipartFormEncapsulationBoundary(self.boundary)) dataUsingEncoding:self.stringEncoding];&#10; &#10;        totalNumberOfBytesRead += [self readData:encapsulationBoundaryData intoBuffer:&#38;buffer[totalNumberOfBytesRead] maxLength:(length - (NSUInteger)totalNumberOfBytesRead)];&#10; &#10;    &#125;&#10;    if (_phase == AFHeaderPhase) &#123;&#10;//content-disposition&#21644;content-length,&#36716;&#25104;NSData&#10;        NSData *headersData = [[self stringForHeaders] dataUsingEncoding:self.stringEncoding];&#10; &#10;        totalNumberOfBytesRead += [self readData:headersData intoBuffer:&#38;buffer[totalNumberOfBytesRead] maxLength:(length - (NSUInteger)totalNumberOfBytesRead)];&#10; &#10;    &#125;&#10; &#10;    if (_phase == AFBodyPhase) &#123;&#10;        NSInteger numberOfBytesRead = 0;&#10;//&#27599;&#20010;AFHTTPBodyPart&#30340;body&#37096;&#20998;&#65292;&#20063;&#23601;&#26159;&#23454;&#38469;&#20256;&#36755;&#30340;&#25968;&#25454;&#37096;&#20998;&#65292;&#37117;&#36890;&#36807;&#22312;inputStream&#26041;&#27861;&#37324;&#26681;&#25454;&#20854;&#23454;&#38469;&#25968;&#25454;&#31867;&#22411;&#36716;&#21270;&#25104;&#20102;NSInputStream&#31867;&#22411;&#23545;&#35937;&#65292;&#25152;&#20197;&#36825;&#37324;&#21482;&#38656;&#35201;&#35843;&#29992;foundation&#33258;&#24102;&#30340;read:maxLength&#26041;&#27861;&#23601;&#34892;&#20102;&#12290;&#10;        numberOfBytesRead = [self.inputStream read:&#38;buffer[totalNumberOfBytesRead] maxLength:(length - (NSUInteger)totalNumberOfBytesRead)];&#10; &#10;        if (numberOfBytesRead == -1) &#123;&#10; &#10;            return -1;&#10; &#10;        &#125; else &#123;&#10; &#10;            totalNumberOfBytesRead += numberOfBytesRead;&#10;            if ([self.inputStream streamStatus] &#62;= NSStreamStatusAtEnd) &#123;&#10; &#10;                [self transitionToNextPhase];&#10;            &#125;&#10;        &#125;&#10;    &#125;&#10; &#10;    if (_phase == AFFinalBoundaryPhase) &#123;&#10;//&#22914;&#26524;&#24403;&#21069;AFHTTPBodyPart&#26159;&#26368;&#21518;&#19968;&#20010;&#21442;&#25968;&#65292;&#37027;&#20040;&#20250;&#27604;&#20854;&#20182;&#21442;&#25968;&#22810;&#19968;&#20010;--boundary--&#30340;&#37096;&#20998;,&#36716;&#25104;NSData&#10;        NSData *closingBoundaryData = ([self hasFinalBoundary] ? [AFMultipartFormFinalBoundary(self.boundary) dataUsingEncoding:self.stringEncoding] : [NSData data]);&#10; &#10;        totalNumberOfBytesRead += [self readData:closingBoundaryData intoBuffer:&#38;buffer[totalNumberOfBytesRead] maxLength:(length - (NSUInteger)totalNumberOfBytesRead)];&#10; &#10;    &#125;&#10; &#10;    return totalNumberOfBytesRead;&#10; &#10;&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">//&#23558;data&#35835;&#20837;buffer&#20013;&#10;- (NSInteger)readData:(NSData *)data&#10; &#10;           intoBuffer:(uint8_t *)buffer&#10; &#10;            maxLength:(NSUInteger)length&#10; &#10;&#123;&#10; &#10;#pragma clang diagnostic push&#10; &#10;#pragma clang diagnostic ignored &#34;-Wgnu&#34;&#10;/*&#27809;&#26377;&#26126;&#30333;&#20026;&#20160;&#20040;&#35835;data&#30340;&#26102;&#20505;range&#20026;&#20160;&#20040;&#35201;&#20174;_phaseReadOffset&#24320;&#22987;&#65292;&#19981;&#24212;&#35813;&#26159;&#20174;0&#24320;&#22987;&#21527;&#65292;&#22240;&#20026;&#27599;&#27425;&#37117;&#26159;&#19968;&#20010;&#20840;&#26032;&#30340;data*/&#10;    NSRange range = NSMakeRange((NSUInteger)_phaseReadOffset, MIN([data length] - ((NSUInteger)_phaseReadOffset), length));&#10;//&#23558;data&#20013;range&#33539;&#22260;&#20043;&#20869;&#30340;&#25968;&#25454;&#22797;&#21046;&#21040;buffer&#37324;&#10;    [data getBytes:buffer range:range];&#10; &#10;#pragma clang diagnostic pop&#10; &#10;    _phaseReadOffset += range.length;&#10; &#10;    if (((NSUInteger)_phaseReadOffset) &#62;= [data length]) &#123;&#10; &#10;        [self transitionToNextPhase];&#10; &#10;    &#125;&#10;    return (NSInteger)range.length;&#10; &#10;&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">//&#24207;&#21015;&#21270;AFHTTPBodyPart&#30340;headers&#37096;&#20998;&#10;- (NSString *)stringForHeaders &#123;&#10;    NSMutableString *headerString = [NSMutableString string];&#10; &#10;    for (NSString *field in [self.headers allKeys]) &#123;&#10; &#10;        [headerString appendString:[NSString stringWithFormat:@&#34;%@: %@%@&#34;, field, [self.headers valueForKey:field], kAFMultipartFormCRLF]];&#10; &#10;    &#125;&#10;    [headerString appendString:kAFMultipartFormCRLF];&#10;    return [NSString stringWithString:headerString];&#10; &#10;&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">//&#35745;&#31639;&#27599;&#20010;AFHTTPBodyPart&#30340;&#20869;&#23481;&#38271;&#24230;&#65292;&#21253;&#25324;&#20256;&#36755;&#21442;&#25968;&#65292;&#35831;&#27714;&#22836;&#21644;boundary&#20449;&#24687;,&#22312;AFMultiStream&#37324;&#20250;&#23558;&#25152;&#26377;&#30340;AFHTTPBodyPart&#30340;content-length&#21152;&#36215;&#26469;&#65292;&#20570;&#20026;&#25972;&#20010;POST&#35831;&#27714;&#20307;&#30340;content-length&#12290;&#10;- (unsigned long long)contentLength &#123;&#10;    unsigned long long length = 0;&#10;//boundary&#10;    NSData *encapsulationBoundaryData = [([self hasInitialBoundary] ? AFMultipartFormInitialBoundary(self.boundary) : AFMultipartFormEncapsulationBoundary(self.boundary)) dataUsingEncoding:self.stringEncoding];&#10;    length += [encapsulationBoundaryData length];&#10;//headers&#10;    NSData *headersData = [[self stringForHeaders] dataUsingEncoding:self.stringEncoding];&#10;    length += [headersData length];&#10;//data&#10;    length += _bodyContentLength;&#10;//close boudary&#10;    NSData *closingBoundaryData = ([self hasFinalBoundary] ? [AFMultipartFormFinalBoundary(self.boundary) dataUsingEncoding:self.stringEncoding] : [NSData data]);&#10;    length += [closingBoundaryData length];&#10;    return length;&#10; &#10;&#125;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/01/26/RunLoop源码分析/" itemprop="url">
                  RunLoop源码分析
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">發表於</span>
            <time itemprop="dateCreated" datetime="2016-01-26T17:02:11+08:00" content="2016-01-26">
              2016-01-26
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/01/26/RunLoop源码分析/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/01/26/RunLoop源码分析/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <h2 id="u6570_u636E_u7ED3_u6784"><a href="#u6570_u636E_u7ED3_u6784" class="headerlink" title="数据结构"></a>数据结构</h2><p><strong>__CFRunLoopMode</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">struct</span> __CFRunLoopMode &#123;</span><br><span class="line">    CFRuntimeBase _base;</span><br><span class="line">    <span class="keyword">pthread_mutex_t</span> _lock;  <span class="comment">/* must have the run loop locked before locking this */</span></span><br><span class="line"><span class="comment">//mode名</span></span><br><span class="line">    CFStringRef _name;</span><br><span class="line">    Boolean _stopped;</span><br><span class="line">    <span class="keyword">char</span> _padding[<span class="number">3</span>];</span><br><span class="line"><span class="comment">//source0 源</span></span><br><span class="line">    CFMutableSetRef _sources0;</span><br><span class="line"><span class="comment">//source1 源</span></span><br><span class="line">    CFMutableSetRef _sources1;</span><br><span class="line"><span class="comment">//observer 源</span></span><br><span class="line">    CFMutableArrayRef _observers;</span><br><span class="line"><span class="comment">//timer 源</span></span><br><span class="line">    CFMutableArrayRef _timers;</span><br><span class="line"> </span><br><span class="line"><span class="comment">//mach port 到 mode的映射,为了在runloop主逻辑中过滤runloop自己的port消息。</span></span><br><span class="line">    CFMutableDictionaryRef _portToV1SourceMap;</span><br><span class="line"> </span><br><span class="line"><span class="comment">//记录了所有当前mode中需要监听的port，作为调用监听消息函数的参数。</span></span><br><span class="line">    __CFPortSet _portSet;</span><br><span class="line">    CFIndex _observerMask;</span><br><span class="line"><span class="preprocessor">#<span class="keyword">if</span> USE_DISPATCH_SOURCE_FOR_TIMERS</span></span><br><span class="line">    <span class="keyword">dispatch_source_t</span> _timerSource;</span><br><span class="line">    <span class="keyword">dispatch_queue_t</span> _queue;</span><br><span class="line">    Boolean _timerFired; <span class="comment">// set to true by the source when a timer has fired</span></span><br><span class="line">    Boolean _dispatchTimerArmed;</span><br><span class="line"><span class="preprocessor">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">if</span> USE_MK_TIMER_TOO</span></span><br><span class="line"><span class="comment">//使用 mk timer， 用到的mach port，和source1类似，都依赖于mach port</span></span><br><span class="line">    <span class="keyword">mach_port_t</span> _timerPort;</span><br><span class="line">    Boolean _mkTimerArmed;</span><br><span class="line"><span class="preprocessor">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="comment">//timer触发的理想时间</span></span><br><span class="line">    <span class="keyword">uint64_t</span> _timerSoftDeadline; <span class="comment">/* TSR */</span></span><br><span class="line"><span class="comment">//timer触发的实际时间，理想时间加上tolerance（偏差）</span></span><br><span class="line">    <span class="keyword">uint64_t</span> _timerHardDeadline; <span class="comment">/* TSR */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
          <div class="post-more-link text-center">
            <a class="btn" href="/2016/01/26/RunLoop源码分析/#more" rel="contents">
              閱讀全文 &raquo;
            </a>
          </div>
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/01/26/RunLoop介绍/" itemprop="url">
                  RunLoop介绍
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">發表於</span>
            <time itemprop="dateCreated" datetime="2016-01-26T17:01:31+08:00" content="2016-01-26">
              2016-01-26
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/01/26/RunLoop介绍/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/01/26/RunLoop介绍/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <h3 id="RunLoop__u7684_u6982_u5FF5"><a href="#RunLoop__u7684_u6982_u5FF5" class="headerlink" title="RunLoop 的概念"></a><strong>RunLoop 的概念</strong></h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">function <span class="title">loop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    initialize();</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        var message = get_next_message();</span><br><span class="line">        process_message(message);</span><br><span class="line">    &#125; <span class="keyword">while</span> (message != quit);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          <div class="post-more-link text-center">
            <a class="btn" href="/2016/01/26/RunLoop介绍/#more" rel="contents">
              閱讀全文 &raquo;
            </a>
          </div>
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/01/26/人生的意义就是活着活好/" itemprop="url">
                  人生的意义
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">發表於</span>
            <time itemprop="dateCreated" datetime="2016-01-26T16:43:10+08:00" content="2016-01-26">
              2016-01-26
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/01/26/人生的意义就是活着活好/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/01/26/人生的意义就是活着活好/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <pre><code>以前思考人生的意义，不知道为什么要工作，每天也不知道要干什么，后来看了活着这部小说，人生的意义就是活好。
</code></pre>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/01/26/hexo-github搭建个人博客/" itemprop="url">
                  hexo+github搭建博客
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">發表於</span>
            <time itemprop="dateCreated" datetime="2016-01-26T16:00:42+08:00" content="2016-01-26">
              2016-01-26
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/01/26/hexo-github搭建个人博客/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/01/26/hexo-github搭建个人博客/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p>前提环境：node.js git</p>
<h4 id="hexo_u5B89_u88C5"><a href="#hexo_u5B89_u88C5" class="headerlink" title="hexo安装"></a>hexo安装</h4><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir MyBlog&#10;cd MyBlog&#10;npm install hexo-cli -g&#10;hexo init&#10;npm install&#10;hexo server</span><br></pre></td></tr></table></figure>
          <div class="post-more-link text-center">
            <a class="btn" href="/2016/01/26/hexo-github搭建个人博客/#more" rel="contents">
              閱讀全文 &raquo;
            </a>
          </div>
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/01/25/Runloop和多线程/" itemprop="url">
                  Runloop和多线程
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">發表於</span>
            <time itemprop="dateCreated" datetime="2016-01-25T16:49:34+08:00" content="2016-01-25">
              2016-01-25
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/01/25/Runloop和多线程/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/01/25/Runloop和多线程/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p>在<a href="http://huanshijiushiniu.github.io/2016/01/26/RunLoop%E4%BB%8B%E7%BB%8D/">CFRunloop</a>中已经说明了一个线程及其runloop的对应关系 ，现在以iOS中NSThread的实际使用来说明runloop在线程中的意义。</p>
          <div class="post-more-link text-center">
            <a class="btn" href="/2016/01/25/Runloop和多线程/#more" rel="contents">
              閱讀全文 &raquo;
            </a>
          </div>
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/01/25/Autolayout和Frame/" itemprop="url">
                  Autolayout和Frame
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">發表於</span>
            <time itemprop="dateCreated" datetime="2016-01-25T16:38:24+08:00" content="2016-01-25">
              2016-01-25
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分類於</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/郑智文/" itemprop="url" rel="index">
                    <span itemprop="name">郑智文</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/01/25/Autolayout和Frame/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/01/25/Autolayout和Frame/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p> 现在iOS页面布局用的最多的就是Frame和Autolayout，在Autolayout通过Masonry封装在实际使用中也十分方便。实际上，Autolayout的约束最后都是系统最终转化成frame来进行布局的，对与一个View来说，最终确定其中心点位置和View的宽高。当Autolayout和Frame设置上产生冲突的时候，则会以Autolayout的设置为准。这篇主要讨论布局中常用的几个方法和autolayout遇到动画的情形。</p>
          <div class="post-more-link text-center">
            <a class="btn" href="/2016/01/25/Autolayout和Frame/#more" rel="contents">
              閱讀全文 &raquo;
            </a>
          </div>
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="//schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="http://7xqgnx.com1.z0.glb.clouddn.com/Red.jpg"
               alt="郑智文" />
          <p class="site-author-name" itemprop="name">郑智文</p>
          <p class="site-description motion-element" itemprop="description">车到山前必有路</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">19</span>
              <span class="site-state-item-name">文章</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              
                <span class="site-state-item-count">1</span>
                <span class="site-state-item-name">分類</span>
              
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">6</span>
                <span class="site-state-item-name">標籤</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">郑智文</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 強力驅動
</div>

<div class="theme-info">
  主題 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.2"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.2"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"zhengzhiwen"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    <script src="/vendors/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  






  
  

  

  

  

</body>
</html>

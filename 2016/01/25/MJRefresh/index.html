<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="博客"><title>MJRefresh | 一只独来独往的水鸟</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/6.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">MJRefresh</h1><a id="logo" href="/.">一只独来独往的水鸟</a><p class="description">iOS</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">MJRefresh</h1><div class="post-meta">Jan 25, 2016<span> | </span><span class="category"><a href="/categories/Tech/">Tech</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span></div><div class="post-content"><h2 id="u57FA_u672C_u539F_u7406_uFF1A"><a href="#u57FA_u672C_u539F_u7406_uFF1A" class="headerlink" title="基本原理："></a>基本原理：</h2><p>通过header view和 foot view 添加对scrollview contentOffset属性 kvo 实现动态刷新。在runtime对scrollview添加header的时候，在view的willMoveToSuperView生命周期方法中进行注册。</p>
<h2 id="u9700_u8981_u8BB0_u5FC6_u7406_u89E3_u7684_u5730_u65B9_uFF1A"><a href="#u9700_u8981_u8BB0_u5FC6_u7406_u89E3_u7684_u5730_u65B9_uFF1A" class="headerlink" title="需要记忆理解的地方："></a>需要记忆理解的地方：</h2><p>1.scrollview往上滑动的时候，contentOffsize的y是正数。scrollview往下滑动的时候，contentOffsize的y是负数。</p>
<p>2.header和footer的位置和大小是在view的layoutSubviews生命周期方法里设置的。</p>
<p>3.通过设置header或者footer的状态的时候控制其行为</p>
<p>小技巧：</p>
<p>1.在子类中调用了父类的方法，如果要求子类在其实现中必须调用父类的方法，可以在方法声明的时候添加 NS_REQUIRES_SUPER 宏，编译器在编译过程可进行检查。</p>
<a id="more"></a> 
<h2 id="u4EE3_u7801_uFF1A"><a href="#u4EE3_u7801_uFF1A" class="headerlink" title="代码："></a>代码：</h2><p>1.MJRefreshNormalHeader</p>
<p>在初始化的时候,会调用init方法，在Init方法里，系统默认调用了initWithFrame方法，frame传的CGRectZero.在MJRefreshNormalHeader的父类</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- (instancetype)initWithFrame:(CGRect)frame&#10;&#123;&#10;    if (self = [super initWithFrame:frame]) &#123;&#10; &#10;        // &#20934;&#22791;&#24037;&#20316;&#10; &#10;        [self prepare];&#10; &#10;        // &#40664;&#35748;&#26159;&#26222;&#36890;&#29366;&#24577;&#10; &#10;        self.state = MJRefreshStateIdle;&#10;    &#125;&#10;    return self;&#10;&#125;</span><br></pre></td></tr></table></figure>
<p>prepare方法设置了header的宽高和x的位置：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- (void)prepare&#10;&#123;&#10;    [super prepare];  &#10; &#10;    // &#35774;&#32622;key&#10; &#10;    self.lastUpdatedTimeKey = MJRefreshHeaderLastUpdatedTimeKey;&#10; &#10;    // &#35774;&#32622;&#39640;&#24230;&#10; &#10;    self.mj_h = MJRefreshHeaderHeight;&#10;&#125;</span><br></pre></td></tr></table></figure>
<p>设置state属性方法：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- (void)setState:(MJRefreshState)state&#10;&#123;&#10;//&#36825;&#20010;&#23439;&#20027;&#35201;&#26159;&#26469;&#20197;&#19979;&#30340;&#36923;&#36753;&#21482;&#26377;&#26159;&#22312;&#29366;&#24577;&#21457;&#29983;&#21464;&#21270;&#30340;&#26102;&#20505;&#25165;&#25191;&#34892;&#65292;&#36991;&#20813;&#37325;&#22797;&#30340;&#36923;&#36753;&#12290;&#10;    MJRefreshCheckState&#10;    // &#26681;&#25454;&#29366;&#24577;&#20570;&#20107;&#24773;&#10; &#10; &#10;//&#20174;&#20854;&#20182;&#29366;&#24577;&#21464;&#25104;&#21021;&#22987;&#38745;&#27490;&#30340;&#29366;&#24577;&#10;    if (state == MJRefreshStateIdle) &#123;&#10; &#10;     //&#36825;&#37324;&#30456;&#24403;&#20110;&#20165;&#29992;&#20110;&#22788;&#29702;&#20174;&#21047;&#26032;&#20013;&#30340;&#29366;&#24577;&#36716;&#21270;&#25104;&#38745;&#27490;&#29366;&#24577;&#10;        if (oldState != MJRefreshStateRefreshing) return;&#10;        // &#20445;&#23384;&#21047;&#26032;&#26102;&#38388;&#10; &#10;        [[NSUserDefaults standardUserDefaults] setObject:[NSDate date] forKey:&#10;        self.lastUpdatedTimeKey];&#10; &#10;        [[NSUserDefaults standardUserDefaults] synchronize];&#10; &#10;        // &#24674;&#22797;inset&#21644;offset&#10; &#10;        [UIView animateWithDuration:MJRefreshSlowAnimationDuration animations:^&#10;        &#123;&#10; &#10;            self.scrollView.mj_insetT += self.insetTDelta;&#10; &#10;            // &#33258;&#21160;&#35843;&#25972;&#36879;&#26126;&#24230;&#10; &#10;            if (self.isAutomaticallyChangeAlpha) self.alpha = 0.0;&#10; &#10;        &#125; completion:^(BOOL finished) &#123;&#10;//&#36825;&#20010;&#23646;&#24615;&#20027;&#35201;&#26159;&#29992;&#26469;&#25511;&#21046;&#38543;&#30528;&#19979;&#25289;&#30340;&#36317;&#31163;&#26469;&#21453;&#24212;&#21040;header&#30340;&#36879;&#26126;&#24230;&#10;            self.pullingPercent = 0.0;&#10; &#10;        &#125;];&#10; &#10;    &#125; else if (state == MJRefreshStateRefreshing) &#123;&#10; &#10;        [UIView animateWithDuration:MJRefreshFastAnimationDuration animations:^&#10;        &#123;&#10; &#10;            // &#22686;&#21152;&#28378;&#21160;&#21306;&#22495;&#10; &#10;            CGFloat top = self.scrollViewOriginalInset.top + self.mj_h;&#10; &#10;            self.scrollView.mj_insetT = top;&#10; &#10;             &#10;            // &#35774;&#32622;&#28378;&#21160;&#20301;&#32622;&#10; &#10;            self.scrollView.mj_offsetY = - top;&#10; &#10;        &#125; completion:^(BOOL finished) &#123;&#10;//&#19994;&#21153;&#36923;&#36753;&#23618;&#30340;&#21047;&#26032;&#25968;&#25454;&#10;            [self executeRefreshingCallback];&#10; &#10;        &#125;];&#10; &#10;    &#125;&#10; &#10;&#125;</span><br></pre></td></tr></table></figure>
<p>根据拖拽进度设置透明度:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- (void)setPullingPercent:(CGFloat)pullingPercent&#10; &#10;&#123;&#10;    _pullingPercent = pullingPercent;&#10; &#10;    if (self.isRefreshing) return;&#10; &#10;    if (self.isAutomaticallyChangeAlpha) &#123;&#10; &#10;        self.alpha = pullingPercent;&#10;    &#125;&#10;&#125;</span><br></pre></td></tr></table></figure>
<p>在UIScrollVIEW+MJRefresh中的setMj_header方法，给UIScrollView动态的添加了一个header，并将它加到了ScrollView上。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- (void)setMj_header:(MJRefreshHeader *)mj_header&#10;&#123;&#10;    if (mj_header != self.mj_header) &#123;&#10; &#10;        // &#21024;&#38500;&#26087;&#30340;&#65292;&#28155;&#21152;&#26032;&#30340;&#10; &#10;        [self.mj_header removeFromSuperview];&#10; &#10;        [self insertSubview:mj_header atIndex:0];&#10;        // &#23384;&#20648;&#26032;&#30340;&#10; &#10;        [self willChangeValueForKey:@&#34;mj_header&#34;]; // KVO&#10; &#10;        objc_setAssociatedObject(self, &#38;MJRefreshHeaderKey,&#10; &#10;                                 mj_header, OBJC_ASSOCIATION_ASSIGN);&#10; &#10;        [self didChangeValueForKey:@&#34;mj_header&#34;]; // KVO&#10;    &#125;&#10;&#125;</span><br></pre></td></tr></table></figure>
<p>将header加到ScrollView上的时候，系统会调用willMoveToSuperview方法，将header从ScrollView删除的时候也会调用这个方法，区别是删除的时候参数传的nil，添加的时候参数为当前scrollView.在这个方法中设置了header的x位置以及header的宽度，并且添加了对scrollview的监听</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- (void)willMoveToSuperview:(UIView *)newSuperview&#10;&#123;&#10;    [super willMoveToSuperview:newSuperview];&#10;    // &#22914;&#26524;&#19981;&#26159;UIScrollView&#65292;&#19981;&#20570;&#20219;&#20309;&#20107;&#24773;&#10;    if (newSuperview &#38;&#38; ![newSuperview isKindOfClass:[UIScrollView class]]) &#10;    return;&#10; &#10;    // &#26087;&#30340;&#29238;&#25511;&#20214;&#31227;&#38500;&#30417;&#21548;&#10;    [self removeObservers];&#10;    if (newSuperview) &#123; // &#26032;&#30340;&#29238;&#25511;&#20214;&#10;        // &#35774;&#32622;&#23485;&#24230;&#10;        self.mj_w = newSuperview.mj_w;&#10; &#10;        // &#35774;&#32622;&#20301;&#32622;&#10;        self.mj_x = 0;&#10;        // &#35760;&#24405;UIScrollView&#10;        _scrollView = (UIScrollView *)newSuperview;&#10; &#10;        // &#35774;&#32622;&#27704;&#36828;&#25903;&#25345;&#22402;&#30452;&#24377;&#31783;&#25928;&#26524;&#10;        _scrollView.alwaysBounceVertical = YES;&#10; &#10;        // &#35760;&#24405;UIScrollView&#26368;&#24320;&#22987;&#30340;contentInset&#10;        _scrollViewOriginalInset = _scrollView.contentInset;&#10; &#10;        // &#28155;&#21152;&#30417;&#21548;&#10;        [self addObservers];&#10;    &#125;&#10;&#125;</span><br></pre></td></tr></table></figure>
<p>添加监听的方法:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- (void)addObservers&#10;&#123;&#10;    NSKeyValueObservingOptions options = NSKeyValueObservingOptionNew | &#10;    NSKeyValueObservingOptionOld;&#10; &#10; &#10;//&#30417;&#27979;&#28369;&#21160;&#36317;&#31163;&#65292;&#21028;&#26029;&#26159;&#21542;&#21040;&#36798;&#38656;&#35201;&#21047;&#26032;&#30340;&#31243;&#24230;&#10;    [self.scrollView addObserver:self forKeyPath:MJRefreshKeyPathContentOffset &#10;    options:options context:nil];&#10;//&#26816;&#27979;contentSize&#21464;&#21270;&#65292;&#27604;&#22914;&#19978;&#25289;&#21152;&#36733;&#26356;&#22810;&#65292;&#21160;&#24577;&#25913;&#21464;footer&#30340;&#20301;&#32622;&#10;    [self.scrollView addObserver:self forKeyPath:MJRefreshKeyPathContentSize &#10;    options:options context:nil];&#10;//&#26816;&#27979;&#24179;&#31227;&#30340;&#25163;&#21183;&#10;    self.pan = self.scrollView.panGestureRecognizer;&#10;    [self.pan addObserver:self forKeyPath:MJRefreshKeyPathPanState options:&#10;    options context:nil];&#10;&#125;</span><br></pre></td></tr></table></figure>
<p>接下来，系统会开始调用layoutSubViews方法：在MJRefreshComponent中重写了这个方法</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- (void)layoutSubviews&#10;&#123;&#10;    [super layoutSubviews];&#10;    [self placeSubviews];&#10;&#125;&#10;  &#10;//placeSubviews&#26041;&#27861;&#26159;&#22312;&#21508;&#20010;MJRefreshComponent&#30340;&#23376;&#31867;&#20013;&#23454;&#29616;&#30340;&#65292;&#10;//&#32487;&#25215;&#38142;:MJRefreshNormalHeader -&#62; MJRefreshStateHeader -&#62; MJRefreshHeader -&#62; MJRefreshComponent&#10;  &#10;//&#20197;&#19979;&#26159;MJRefreshHeader&#20013;&#30340;&#23454;&#29616;,&#35774;&#32622;&#20102;header&#30340;y&#30340;&#20301;&#32622;&#10;- (void)placeSubviews&#10;&#123;&#10;    [super placeSubviews];&#10;    // &#35774;&#32622;y&#20540;(&#24403;&#33258;&#24049;&#30340;&#39640;&#24230;&#21457;&#29983;&#25913;&#21464;&#20102;&#65292;&#32943;&#23450;&#35201;&#37325;&#26032;&#35843;&#25972;Y&#20540;&#65292;&#10;    //&#25152;&#20197;&#25918;&#21040;placeSubviews&#26041;&#27861;&#20013;&#35774;&#32622;y&#20540;)&#10;    self.mj_y = - self.mj_h - self.ignoredScrollViewContentInsetTop;&#10;&#125;&#10;  &#10;//&#20197;&#19979;&#26159;MJRefreshStateHeader&#20013;&#30340;&#23454;&#29616;,&#28155;&#21152;&#21047;&#26032;&#29366;&#20307;&#21644;&#26356;&#26032;&#26102;&#38388;&#10;- (void)placeSubviews&#10;&#123;&#10;    [super placeSubviews];&#10;    if (self.stateLabel.hidden) return;&#10; &#10;    BOOL noConstrainsOnStatusLabel = self.stateLabel.constraints.count == 0;&#10; &#10;    if (self.lastUpdatedTimeLabel.hidden) &#123;&#10; &#10;        // &#29366;&#24577;&#10; &#10;        if (noConstrainsOnStatusLabel) self.stateLabel.frame = self.bounds;&#10; &#10;    &#125; else &#123;&#10; &#10;        CGFloat stateLabelH = self.mj_h * 0.5;&#10; &#10;        // &#29366;&#24577;&#10; &#10;        if (noConstrainsOnStatusLabel) &#123;&#10; &#10;            self.stateLabel.mj_x = 0;&#10; &#10;            self.stateLabel.mj_y = 0;&#10; &#10;            self.stateLabel.mj_w = self.mj_w;&#10; &#10;            self.stateLabel.mj_h = stateLabelH;&#10;        &#125;&#10; &#10;        // &#26356;&#26032;&#26102;&#38388;&#10;        if (self.lastUpdatedTimeLabel.constraints.count == 0) &#123;&#10; &#10;            self.lastUpdatedTimeLabel.mj_x = 0;&#10; &#10;            self.lastUpdatedTimeLabel.mj_y = stateLabelH;&#10; &#10;            self.lastUpdatedTimeLabel.mj_w = self.mj_w;&#10; &#10;            self.lastUpdatedTimeLabel.mj_h = self.mj_h - self.lastUpdatedTimeLabel.mj_y;&#10;        &#125;&#10;    &#125;&#10;&#125;&#10;  &#10;//&#20197;&#19979;&#26159;MJRefreshNormalHeader&#20013;&#30340;&#23454;&#29616;&#65292;&#28155;&#21152;&#21098;&#22836;&#21644;loadingview&#10;- (void)placeSubviews&#10;&#123;&#10;    [super placeSubviews];&#10;    // &#31661;&#22836;&#30340;&#20013;&#24515;&#28857;&#10; &#10;    CGFloat arrowCenterX = self.mj_w * 0.5;&#10; &#10;    if (!self.stateLabel.hidden) &#123;&#10;        arrowCenterX -= 100;&#10;    &#125;&#10; &#10;    CGFloat arrowCenterY = self.mj_h * 0.5;&#10; &#10;    CGPoint arrowCenter = CGPointMake(arrowCenterX, arrowCenterY);&#10; &#10;    // &#31661;&#22836;&#10;    if (self.arrowView.constraints.count == 0) &#123;&#10;        self.arrowView.mj_size = self.arrowView.image.size;&#10;        self.arrowView.center = arrowCenter;&#10;    &#125;&#10; &#10;    // &#22280;&#22280;&#10;    if (self.loadingView.constraints.count == 0) &#123;&#10;        self.loadingView.center = arrowCenter;&#10;    &#125;&#10;&#125;</span><br></pre></td></tr></table></figure>
<p>header中监控下拉距离的方法：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- (void)scrollViewContentOffsetDidChange:(NSDictionary *)change&#10;&#123;&#10;    [super scrollViewContentOffsetDidChange:change];&#10; &#10;    // &#22312;&#21047;&#26032;&#30340;refreshing&#29366;&#24577;&#10; &#10;    if (self.state == MJRefreshStateRefreshing) &#123;&#10;        if (self.window == nil) return;&#10;        // sectionheader&#20572;&#30041;&#35299;&#20915;&#10;        CGFloat insetT = - self.scrollView.mj_offsetY &#62; _scrollViewOriginalInset.top ? - self.scrollView.mj_offsetY : &#10;        _scrollViewOriginalInset.top;&#10;        insetT = insetT &#62; self.mj_h + _scrollViewOriginalInset.top ? self.mj_h&#10;         + _scrollViewOriginalInset.top : insetT;&#10;        self.scrollView.mj_insetT = insetT;&#10;        self.insetTDelta = _scrollViewOriginalInset.top - insetT;&#10;        return;&#10;    &#125;&#10; &#10;    // &#36339;&#36716;&#21040;&#19979;&#19968;&#20010;&#25511;&#21046;&#22120;&#26102;&#65292;contentInset&#21487;&#33021;&#20250;&#21464;&#10;     _scrollViewOriginalInset = self.scrollView.contentInset;&#10; &#10;    // &#24403;&#21069;&#30340;contentOffset&#10;    CGFloat offsetY = self.scrollView.mj_offsetY;&#10; &#10;    // &#22836;&#37096;&#25511;&#20214;&#21018;&#22909;&#20986;&#29616;&#30340;offsetY&#10;    CGFloat happenOffsetY = - self.scrollViewOriginalInset.top;&#10;    // &#22914;&#26524;&#26159;&#21521;&#19978;&#28378;&#21160;&#21040;&#30475;&#19981;&#35265;&#22836;&#37096;&#25511;&#20214;&#65292;&#30452;&#25509;&#36820;&#22238;&#10;    if (offsetY &#62; happenOffsetY) return;&#10; &#10;    // &#26222;&#36890; &#21644; &#21363;&#23558;&#21047;&#26032; &#30340;&#20020;&#30028;&#28857;, self.mj_h&#26159;&#24403;&#21069;header&#30340;&#39640;&#24230;&#10;    CGFloat normal2pullingOffsetY = happenOffsetY - self.mj_h;&#10;    CGFloat pullingPercent = (happenOffsetY - offsetY) / self.mj_h;&#10; &#10;    if (self.scrollView.isDragging) &#123; // &#22914;&#26524;&#27491;&#22312;&#25302;&#25341;&#10;        self.pullingPercent = pullingPercent;&#10;//header&#27491;&#22909;&#23436;&#20840;&#38706;&#20986;&#26469;&#65292;&#24320;&#22987;&#36716;&#20026;&#21047;&#26032;&#29366;&#24577;&#10;        if (self.state == MJRefreshStateIdle &#38;&#38; offsetY &#60; normal2pullingOffsetY&#10;            ) &#123;&#10;            // &#36716;&#20026;&#21363;&#23558;&#21047;&#26032;&#29366;&#24577;&#10;            self.state = MJRefreshStatePulling;&#10;        &#125; else if (self.state == MJRefreshStatePulling &#38;&#38; offsetY &#62;= &#10;            normal2pullingOffsetY) &#123;&#10;            // &#36716;&#20026;&#26222;&#36890;&#29366;&#24577;&#10;            self.state = MJRefreshStateIdle;&#10;        &#125;&#10;    &#125; else if (self.state == MJRefreshStatePulling) &#123;// &#21363;&#23558;&#21047;&#26032; &#38;&#38; &#25163;&#26494;&#24320;&#10;        // &#24320;&#22987;&#21047;&#26032;&#10;        [self beginRefreshing];&#10;    &#125; else if (pullingPercent &#60; 1) &#123;&#10;        self.pullingPercent = pullingPercent;&#10;    &#125;&#10;&#125;</span><br></pre></td></tr></table></figure>
<p>footer同header一样都继承自MJFfreshComponent，都自动检测scrollview的行为，各自实现具体的被通知的逻辑</p>
<p>MJRefreshAutoFooter的实现：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- (void)scrollViewContentOffsetDidChange:(NSDictionary *)change&#10;&#123;&#10;    [super scrollViewContentOffsetDidChange:change];&#10;    if (self.state != MJRefreshStateIdle || !self.automaticallyRefresh || self.&#10;        mj_y == 0) return;&#10; &#10;  &#10;    if (_scrollView.mj_insetT + _scrollView.mj_contentH &#62; _scrollView.mj_h) &#123; &#10;    // &#20869;&#23481;&#36229;&#36807;&#19968;&#20010;&#23631;&#24149;&#10; &#10;        // &#36825;&#37324;&#30340;_scrollView.mj_contentH&#26367;&#25442;&#25481;self.mj_y&#26356;&#20026;&#21512;&#29702;&#10; &#10;        if (_scrollView.mj_offsetY &#62;= _scrollView.mj_contentH - _scrollView.&#10;            mj_h + self.mj_h * self.triggerAutomaticallyRefreshPercent + &#10;            _scrollView.mj_insetB - self.mj_h) &#123;&#10; &#10;            // &#38450;&#27490;&#25163;&#26494;&#24320;&#26102;&#36830;&#32493;&#35843;&#29992;&#10; &#10;            CGPoint old = [change[@&#34;old&#34;] CGPointValue];&#10; &#10;            CGPoint new = [change[@&#34;new&#34;] CGPointValue];&#10; &#10;            if (new.y &#60;= old.y) return;&#10; &#10;            // &#24403;&#24213;&#37096;&#21047;&#26032;&#25511;&#20214;&#23436;&#20840;&#20986;&#29616;&#26102;&#65292;&#25165;&#21047;&#26032;&#10; &#10;            [self beginRefreshing];&#10;        &#125;&#10;    &#125;&#10;&#125;&#10; &#10;- (void)scrollViewPanStateDidChange:(NSDictionary *)change&#10;&#123;&#10;    [super scrollViewPanStateDidChange:change];&#10; &#10;    if (self.state != MJRefreshStateIdle) return;&#10; &#10;    if (_scrollView.panGestureRecognizer.state == UIGestureRecognizerStateEnded&#10;    ) &#123;// &#25163;&#26494;&#24320;&#10;        if (_scrollView.mj_insetT + _scrollView.mj_contentH &#60;= _scrollView.mj_h&#10;        ) &#123;  // &#19981;&#22815;&#19968;&#20010;&#23631;&#24149;&#10;            if (_scrollView.mj_offsetY &#62;= - _scrollView.mj_insetT) &#123; // &#21521;&#19978;&#25341;&#10;                [self beginRefreshing];&#10;            &#125;&#10;        &#125; else &#123; // &#36229;&#20986;&#19968;&#20010;&#23631;&#24149;&#10;            if (_scrollView.mj_offsetY &#62;= _scrollView.mj_contentH + _scrollView&#10;                .mj_insetB - _scrollView.mj_h) &#123;&#10;                [self beginRefreshing];&#10;            &#125;&#10;        &#125;&#10;    &#125;&#10;&#125;</span><br></pre></td></tr></table></figure>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://yoursite.com/2016/01/25/MJRefresh/" data-id="cj5jc89ti00121wcvn3r29rzg" class="article-share-link">分享</a><div class="tags"><a href="/tags/源码分析/">源码分析</a></div><div class="post-nav"><a href="/2016/01/25/ReactCocoa源码分析1/" class="pre">ReactCocoa源码分析1</a><a href="/2016/01/25/MLLeaksFinder/" class="next">MLLeaksFinder</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://yoursite.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Tech/">Tech</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Tools/">Tools</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/源码分析/" style="font-size: 15px;">源码分析</a> <a href="/tags/hexo/" style="font-size: 15px;">hexo</a> <a href="/tags/iOS/" style="font-size: 15px;">iOS</a> <a href="/tags/git/" style="font-size: 15px;">git</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/07/25/GitHook/">Git Hook</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/19/Method Swizzle中的对象模型/">Method Swizzle中的对象模型</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/19/iOS定位库-INTULocationRequest/">iOS定位库-INTULocationRequest</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/10/13/AFNetWorking—NSURLSession/">AFNetWorking—NSURLSession</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/10/13/AFNetworking-NSURLConnection/">AFNetworking-NSURLConnection</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/10/13/AFNetworking-ResponseSerializer/">AFNetworking-ResponseSerializer</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/10/13/AFNetworking-RequestSerializer/">AFNetworking-RequestSerializer</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/26/CFRunLoop/">CFRunLoop</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/26/RunLoop介绍/">RunLoop介绍</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/26/hexo-github搭建博客/">hexo+github搭建博客</a></li></ul></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2017 <a href="/." rel="nofollow">一只独来独往的水鸟.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>
<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="博客"><title>AFNetworking源码分析3-返回数据的反序列化 | 郑智文</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/6.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">AFNetworking源码分析3-返回数据的反序列化</h1><a id="logo" href="/.">郑智文</a><p class="description">iOS</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">AFNetworking源码分析3-返回数据的反序列化</h1><div class="post-meta">Oct 13, 2016<script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span></div><div class="post-content"><h2 id="u6982_u51B5_uFF1A"><a href="#u6982_u51B5_uFF1A" class="headerlink" title="概况："></a>概况：</h2><p>这部分比较简单，一共有以下几个类：</p>
<ul>
<li>AFHTTPResponseSerializer</li>
<li>AFJSONResponseSerializer  : AFHTTPResponseSerializer</li>
<li>AFXMLParseResponseSerializer : AFHTTPResponseSerializer</li>
<li>AFXMLDocumentResponseSerializer : AFHTTPResponseSerializer</li>
<li>AFPropertyListResponseSerializer : AFHTTPResponseSerializer</li>
<li>AFImageResponseSerializer : AFHTTPResponseSerializer</li>
<li>AFCompoundResponseSerializer : AFHTTPResponseSerializer</li>
</ul>
<h2 id="AFHTTPResponseSerializer"><a href="#AFHTTPResponseSerializer" class="headerlink" title="AFHTTPResponseSerializer"></a>AFHTTPResponseSerializer</h2><p>这个类主要是验证response合法性，是否是有效的response</p>
<p><strong>validateResponse:data:error:</strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- (BOOL)validateResponse:(NSHTTPURLResponse *)response&#10;                    data:(NSData *)data&#10;                   error:(NSError * __autoreleasing *)error&#10; &#10;&#123;&#10;    BOOL responseIsValid = YES;&#10;    NSError *validationError = nil;&#10;    if (response &#38;&#38; [response isKindOfClass:[NSHTTPURLResponse class]]) &#123;&#10;//acceptableContentTypes&#37324;&#23384;&#20648;&#20102;&#24403;&#21069;serializer&#25903;&#25345;&#30340;content-type&#65292;&#21487;&#20197;&#22312;&#19981;&#21516;&#30340;&#23376;&#31867;init&#26041;&#27861;&#20013;&#25351;&#23450;&#12290;&#10;//&#26377;&#26102;&#20505;&#65292;&#36890;&#36807;charlse&#21435;mock&#35831;&#27714;&#30340;response&#65292;&#27809;&#26377;&#36890;&#36807;rewrite&#21151;&#33021;&#37325;&#20889;content-type(&#40664;&#35748;&#26159;text/plain)&#20026;application/json&#23601;&#20250;&#34987;afnetworking&#26174;&#31034;&#35831;&#27714;&#22833;&#36133;&#65292;not accept content-type &#38169;&#35823;&#12290;&#10;        if (self.acceptableContentTypes &#38;&#38; ![self.acceptableContentTypes containsObject:[response MIMEType]]) &#123;&#10; &#10;            if ([data length] &#62; 0 &#38;&#38; [response URL]) &#123;&#10; &#10;                NSMutableDictionary *mutableUserInfo = [@&#123;&#10; &#10;                                                          NSLocalizedDescriptionKey: [NSString stringWithFormat:NSLocalizedStringFromTable(@&#34;Request failed: unacceptable content-type: %@&#34;, @&#34;AFNetworking&#34;, nil), [response MIMEType]],&#10; &#10;                                                          NSURLErrorFailingURLErrorKey:[response URL],&#10; &#10;                                                          AFNetworkingOperationFailingURLResponseErrorKey: response,&#10; &#10;                                                        &#125; mutableCopy];&#10; &#10;                if (data) &#123;&#10; &#10;                    mutableUserInfo[AFNetworkingOperationFailingURLResponseDataErrorKey] = data;&#10; &#10;                &#125;&#10; &#10;                validationError = AFErrorWithUnderlyingError([NSError errorWithDomain:AFURLResponseSerializationErrorDomain code:NSURLErrorCannotDecodeContentData userInfo:mutableUserInfo], validationError);&#10; &#10;            &#125;&#10; &#10;            responseIsValid = NO;&#10;        &#125;&#10;//acceptableStatusCodes&#23384;&#20648;&#20102;&#24403;&#21069;serializer&#25903;&#25345;&#30340;&#36820;&#22238;&#30721;&#65292;&#37324;&#38754;&#30340;&#20540;&#26159;&#22312;AFHTTPResponseSerializer&#22522;&#31867;&#10;&#35843;&#29992;init&#26041;&#27861;&#20013;&#25351;&#23450;&#30340;&#12290;&#10;        if (self.acceptableStatusCodes &#38;&#38; ![self.acceptableStatusCodes containsIndex:(NSUInteger)response.statusCode] &#38;&#38; [response URL]) &#123;&#10; &#10;            NSMutableDictionary *mutableUserInfo = [@&#123;&#10; &#10;                                               NSLocalizedDescriptionKey: [NSString stringWithFormat:NSLocalizedStringFromTable(@&#34;Request failed: %@ (%ld)&#34;, @&#34;AFNetworking&#34;, nil), [NSHTTPURLResponse localizedStringForStatusCode:response.statusCode], (long)response.statusCode],&#10; &#10;                                               NSURLErrorFailingURLErrorKey:[response URL],&#10; &#10;                                               AFNetworkingOperationFailingURLResponseErrorKey: response,&#10; &#10;                                       &#125; mutableCopy];&#10;            if (data) &#123;&#10; &#10;                mutableUserInfo[AFNetworkingOperationFailingURLResponseDataErrorKey] = data;&#10; &#10;            &#125;&#10; &#10;            validationError = AFErrorWithUnderlyingError([NSError errorWithDomain:AFURLResponseSerializationErrorDomain code:NSURLErrorBadServerResponse userInfo:mutableUserInfo], validationError);&#10;            responseIsValid = NO;&#10;        &#125;&#10;    &#125;&#10;    if (error &#38;&#38; !responseIsValid) &#123;&#10; &#10;        *error = validationError;&#10; &#10;    &#125;&#10;    return responseIsValid;&#10;&#125;</span><br></pre></td></tr></table></figure>
<p><strong>AFHTTPResponseSerializer</strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">//&#21482;&#20570;&#20102;response&#30340;&#39564;&#35777;&#36923;&#36753;&#65292;&#20855;&#20307;&#30340;&#21453;&#24207;&#21015;&#21270;&#22312;&#21508;&#20010;&#23376;&#31867;&#20013;&#23454;&#29616;&#12290;&#10;//&#25152;&#26377;&#30340;serializer&#37117;&#35201;&#23454;&#29616;&#36825;&#20010;&#26041;&#27861;,&#22312;&#32593;&#32476;&#35831;&#27714;&#25104;&#21151;&#36820;&#22238;&#25968;&#25454;&#20043;&#21518;&#65292;AFNetworking&#23601;&#20250;&#35843;&#29992;serializer&#36825;&#20010;&#26041;&#27861;&#26469;&#21453;&#24207;&#21015;&#21270;&#12290;&#10;- (id)responseObjectForResponse:(NSURLResponse *)response&#10;                           data:(NSData *)data&#10;                          error:(NSError *__autoreleasing *)error&#10;&#123;&#10;    [self validateResponse:(NSHTTPURLResponse *)response data:data error:error];&#10;    return data;&#10;&#125;</span><br></pre></td></tr></table></figure>
<h2 id="AFJSONResponseSerializer"><a href="#AFJSONResponseSerializer" class="headerlink" title="AFJSONResponseSerializer"></a>AFJSONResponseSerializer</h2><p><strong>responseObjectForResponse:data:error</strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- (id)responseObjectForResponse:(NSURLResponse *)response&#10;                           data:(NSData *)data&#10;                          error:(NSError *__autoreleasing *)error&#10;&#123;&#10; &#10;    if (![self validateResponse:(NSHTTPURLResponse *)response data:data error:error]) &#123;&#10; &#10;        if (!error || AFErrorOrUnderlyingErrorHasCodeInDomain(*error, NSURLErrorCannotDecodeContentData, AFURLResponseSerializationErrorDomain)) &#123;&#10; &#10;            return nil;&#10; &#10;        &#125;&#10; &#10;    &#125;&#10; &#10;    // Workaround for behavior of Rails to return a single space for `head :ok` (a workaround for a bug in Safari), which is not interpreted as valid input by NSJSONSerialization.&#10; &#10;    // See https://github.com/rails/rails/issues/1742&#10; &#10;    NSStringEncoding stringEncoding = self.stringEncoding;&#10; &#10;    if (response.textEncodingName) &#123;&#10; &#10;        CFStringEncoding encoding = CFStringConvertIANACharSetNameToEncoding((CFStringRef)response.textEncodingName);&#10; &#10;        if (encoding != kCFStringEncodingInvalidId) &#123;&#10;            stringEncoding = CFStringConvertEncodingToNSStringEncoding(encoding);&#10;        &#125;&#10;    &#125;&#10; &#10;    id responseObject = nil;&#10; &#10;    NSError *serializationError = nil;&#10; &#10;    @autoreleasepool &#123;&#10; &#10;        NSString *responseString = [[NSString alloc] initWithData:data encoding:stringEncoding];&#10; &#10;        if (responseString &#38;&#38; ![responseString isEqualToString:@&#34; &#34;]) &#123;&#10; &#10;            // Workaround for a bug in NSJSONSerialization when Unicode character escape codes are used instead of the actual character&#10; &#10;            // See http://stackoverflow.com/a/12843465/157142&#10; &#10;            data = [responseString dataUsingEncoding:NSUTF8StringEncoding];&#10; &#10;            if (data) &#123;&#10; &#10;                if ([data length] &#62; 0) &#123;&#10;                    responseObject = [NSJSONSerialization JSONObjectWithData:data options:self.readingOptions error:&#38;serializationError];&#10;                &#125; else &#123;&#10;                    return nil;&#10;                &#125;&#10; &#10;            &#125; else &#123;&#10; &#10;                NSDictionary *userInfo = @&#123;&#10; &#10;                                           NSLocalizedDescriptionKey: NSLocalizedStringFromTable(@&#34;Data failed decoding as a UTF-8 string&#34;, @&#34;AFNetworking&#34;, nil),&#10; &#10;                                           NSLocalizedFailureReasonErrorKey: [NSString stringWithFormat:NSLocalizedStringFromTable(@&#34;Could not decode string: %@&#34;, @&#34;AFNetworking&#34;, nil), responseString]&#10; &#10;                                           &#125;;&#10;                serializationError = [NSError errorWithDomain:AFURLResponseSerializationErrorDomain code:NSURLErrorCannotDecodeContentData userInfo:userInfo];&#10;            &#125;&#10;        &#125;&#10;    &#125;&#10;//1.removesKeysWithNullValues&#34920;&#31034;&#24403;&#36820;&#22238;&#30340;&#25968;&#25454;dictionary&#30340;value&#20026;NSNULL&#30340;&#24773;&#20917;&#30340;&#26102;&#20505;&#65292;&#26159;&#21542;&#31227;&#38500;&#23545;&#24212;&#38190;&#20540;&#23545;&#12290;&#19981;&#22788;&#29702;&#20250;&#23548;&#33268;&#21069;&#31471;crash&#65292;&#22914;&#26524;&#19981;&#35774;&#32622;&#36825;&#20010;&#23646;&#24615;&#65292;&#40664;&#35748;&#26159;false&#10;//2.self.readingOptions&#21487;&#20197;&#26681;&#25454;&#38656;&#27714;&#29992;&#26469;&#35774;&#32622;&#26368;&#21518;&#21453;&#24207;&#21015;&#21270;&#20986;&#23383;&#20856;&#26159;&#21542;&#26410;&#21487;&#21464;&#31867;&#22411;(NSJSONReadingMutableContainers)&#65292;&#40664;&#35748;&#26159;&#19981;&#21487;&#21464;&#31867;&#22411;&#10;    if (self.removesKeysWithNullValues &#38;&#38; responseObject) &#123;&#10;        responseObject = AFJSONObjectByRemovingKeysWithNullValues(responseObject, self.readingOptions);&#10;    &#125;&#10;    if (error) &#123;&#10;        *error = AFErrorWithUnderlyingError(serializationError, *error);&#10;    &#125;&#10;    return responseObject;&#10;&#125;</span><br></pre></td></tr></table></figure>
<h2 id="AFCompoundResponseSerializer"><a href="#AFCompoundResponseSerializer" class="headerlink" title="AFCompoundResponseSerializer"></a>AFCompoundResponseSerializer</h2><p><strong>responseObjectForResponse:data:error:</strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">//&#36825;&#20010;&#31867;&#20027;&#35201;&#26159;&#21487;&#20197;&#21512;&#24182;&#22810;&#20013;Serializer&#30340;&#21151;&#33021;&#65292;&#23384;&#20648;&#22312;self.responseSerializers&#38598;&#21512;&#20013;&#12290;&#10;- (id)responseObjectForResponse:(NSURLResponse *)response&#10;                           data:(NSData *)data&#10;                          error:(NSError *__autoreleasing *)error&#10; &#10;&#123;&#10;//&#36825;&#37324;&#27809;&#26377;&#35843;&#29992;validateResponse&#26041;&#27861;&#65292;&#22240;&#20026;&#36825;&#20010;&#31867;&#22788;&#29702;&#30340;&#19981;&#26159;&#26576;&#19968;&#20010;&#20855;&#20307;&#30340;response&#31867;&#22411;&#10;    for (id &#60;AFURLResponseSerialization&#62; serializer in self.responseSerializers) &#123;&#10;        if (![serializer isKindOfClass:[AFHTTPResponseSerializer class]]) &#123;&#10;            continue;&#10;        &#125;&#10; &#10;        NSError *serializerError = nil;&#10;        id responseObject = [serializer responseObjectForResponse:response data:data error:&#38;serializerError];&#10;        if (responseObject) &#123;&#10;            if (error) &#123;&#10;                *error = AFErrorWithUnderlyingError(serializerError, *error);&#10;            &#125;&#10; &#10;            return responseObject;&#10;        &#125;&#10; &#10;    &#125;&#10;    return [super responseObjectForResponse:response data:data error:error];&#10;&#125;</span><br></pre></td></tr></table></figure>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://yoursite.com/2016/10/13/AFNetworking源码分析3-返回参数反序列化/" data-id="ciu8fnlv0000j1rcvob23t8sy" class="article-share-link">分享</a><div class="tags"><a href="/tags/源码阅读/">源码阅读</a></div><div class="post-nav"><a href="/2016/10/13/AFNetWorking源码分析总结5——NSURLSession/" class="pre">AFNetWorking源码分析总结5——NSURLSession</a><a href="/2016/10/13/AFNetworking源码分析2-请求参数序列化/" class="next">AFNetworking源码解析2-请求参数序列化</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://yoursite.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/郑智文/">郑智文</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/源码阅读/" style="font-size: 15px;">源码阅读</a> <a href="/tags/技术之外/" style="font-size: 15px;">技术之外</a> <a href="/tags/hexo/" style="font-size: 15px;">hexo</a> <a href="/tags/iOS-Tech/" style="font-size: 15px;">iOS Tech</a> <a href="/tags/iOS/" style="font-size: 15px;">iOS</a> <a href="/tags/源码分析/" style="font-size: 15px;">源码分析</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2016/10/13/AFNetworking 源码分析总结4 NSURLConnection/">AFNetworking 源码分析总结4</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/10/13/AFNetWorking源码分析总结5——NSURLSession/">AFNetWorking源码分析总结5——NSURLSession</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/10/13/AFNetworking源码分析3-返回参数反序列化/">AFNetworking源码分析3-返回数据的反序列化</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/10/13/AFNetworking源码分析2-请求参数序列化/">AFNetworking源码解析2-请求参数序列化</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/26/RunLoop源码分析/">RunLoop源码分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/26/RunLoop介绍/">RunLoop介绍</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/26/人生的意义就是活着活好/">人生的意义</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/26/hexo-github搭建个人博客/">hexo+github搭建博客</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/25/Runloop和多线程/">Runloop和多线程</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/25/Autolayout和Frame/">Autolayout和Frame</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2017 <a href="/." rel="nofollow">郑智文.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>
<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="博客"><title>AFNetworking-RequestSerializer | 一只独来独往的水鸟</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/6.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">AFNetworking-RequestSerializer</h1><a id="logo" href="/.">一只独来独往的水鸟</a><p class="description">iOS</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">AFNetworking-RequestSerializer</h1><div class="post-meta">Oct 13, 2016<span> | </span><span class="category"><a href="/categories/Tech/">Tech</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span></div><div class="post-content"><h2 id="u6982_u51B5_u4ECB_u7ECD_uFF1A"><a href="#u6982_u51B5_u4ECB_u7ECD_uFF1A" class="headerlink" title="概况介绍："></a>概况介绍：</h2><p>这篇主要介绍AFNetworking中请求参数序列化的部分,具体代码在AFURLRequestSerialization中。AFURLRequestSerialization包含四部分:</p>
<ul>
<li>AFHTTPRequestSerializaiton</li>
<li>AFJSONRequestSerializer</li>
<li>AFPropertyListRequestSerializer</li>
</ul>
<p>AFHTTPRequestSerialization主要是设置http请求头,设置超时时间,BA认证，处理用户名密码登陆等等。主要功能分3大块：</p>
<ol>
<li>处理所有的GET,HEAD,DELETE请求</li>
<li>处理content-type是application/x-www-form-urlencoded类型的POST请求</li>
<li>处理content-type是multipart/form-data类型的POST请求，请求的构建是通过AFStreamingMultipartFormData对象实现的。</li>
</ol>
<p>AFJSONRequestSerializer继承自AFHTTPRequestSerialization类，使用NSJSONSerialization序列化json格式(application/json)的参数，将一个Dictionary对象转化成NSData，它只处理POST请求。</p>
<p>AFPropertyListRequestSerializer也继承了AFHTTPRequestSerialization类，使用NSPropertyListSerialization对象来序列化xml格式(application/x-plist)的参数，它也只处理POST请求。</p>
<p>综上所述，AFHTTPRequestSerialization是最重要也是最复杂的部分，源码也主要针对这部分做分析。</p>
<h2 id="u6E90_u7801_u5206_u6790_uFF1A"><a href="#u6E90_u7801_u5206_u6790_uFF1A" class="headerlink" title="源码分析："></a>源码分析：</h2><h3 id="u53C2_u6570_u5E8F_u5217_u5316_u548C_u7F16_u7801"><a href="#u53C2_u6570_u5E8F_u5217_u5316_u548C_u7F16_u7801" class="headerlink" title="参数序列化和编码"></a>参数序列化和编码</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- (NSURLRequest *)requestBySerializingRequest:(NSURLRequest *)request&#10; &#10;                               withParameters:(id)parameters&#10; &#10;                                        error:(NSError *__autoreleasing *)error&#10; &#10;&#123;&#10; &#10;    NSParameterAssert(request);&#10; &#10;    NSMutableURLRequest *mutableRequest = [request mutableCopy];&#10;//&#35774;&#32622;http&#35831;&#27714;&#22836;&#10;    [self.HTTPRequestHeaders enumerateKeysAndObjectsUsingBlock:^(id field, id &#10;        value, BOOL * __unused stop) &#123;&#10; &#10;        if (![request valueForHTTPHeaderField:field]) &#123;&#10; &#10;            [mutableRequest setValue:value forHTTPHeaderField:field];&#10;        &#125;&#10;    &#125;];&#10;//&#24207;&#21015;&#21270;&#21442;&#25968;&#10;    if (parameters) &#123;&#10; &#10;        NSString *query = nil;&#10;//queryStringSerilization&#26159;&#19968;&#20010;block&#65292;&#20027;&#35201;&#26159;&#29992;&#26469;&#33258;&#23450;&#20041;&#21442;&#25968;&#24207;&#21015;&#21270;&#30340;&#36923;&#36753;&#65292;&#36820;&#22238;&#19968;&#20010;&#24207;&#21015;&#21270;&#23436;&#25104;&#30340;&#32467;&#26524;&#10;        if (self.queryStringSerialization) &#123;&#10; &#10;            NSError *serializationError;&#10; &#10;            query = self.queryStringSerialization(request, parameters, &#38;&#10;                serializationError);&#10; &#10;            if (serializationError) &#123;&#10; &#10;                if (error) &#123;&#10; &#10;                    *error = serializationError;&#10; &#10;                &#125;&#10; &#10;                return nil;&#10;            &#125;&#10;        &#125; else &#123;&#10; &#10;            switch (self.queryStringSerializationStyle) &#123;&#10;//&#20351;&#29992;AFNetworking&#40664;&#35748;&#30340;&#26684;&#24335;&#24207;&#21015;&#21270;&#65292;a=1&#38;b=2&#36825;&#31181;&#10;                case AFHTTPRequestQueryStringDefaultStyle:&#10;//&#36825;&#37324;parameters&#26159;&#19968;&#20010;dictionary&#23545;&#35937;,stringEncoding&#26159;&#32473;httpBody&#35774;&#32622;data&#30340;&#26102;&#20505;&#23383;&#31526;&#10;//&#20018;&#30340;&#32534;&#30721;&#26684;&#24335;&#10;                    query = AFQueryStringFromParametersWithEncoding(parameters, self.stringEncoding);&#10; &#10;                    break;&#10; &#10;            &#125;&#10; &#10;        &#125;&#10;//HTTPMethodsEncodingParametersInURI&#23450;&#20041;&#20102;GET,DELETE,HEAD3&#31181;&#26041;&#27861;&#10;        if ([self.HTTPMethodsEncodingParametersInURI containsObject:[[request &#10;            HTTPMethod] uppercaseString]]) &#123;&#10; &#10;            mutableRequest.URL = [NSURL URLWithString:[[mutableRequest.URL absoluteString] stringByAppendingFormat:mutableRequest.URL.query ? &#10;            @&#34;&#38;%@&#34; : @&#34;?%@&#34;, query]];&#10; &#10;        &#125; else &#123;&#10;//POST&#10;            if (![mutableRequest valueForHTTPHeaderField:@&#34;Content-Type&#34;]) &#123;&#10; &#10;                [mutableRequest setValue:@&#34;application/x-www-form-urlencoded&#34; forHTTPHeaderField:@&#34;Content-Type&#34;];&#10; &#10;            &#125;&#10;//setHTTPBody&#25509;&#21463;&#19968;&#20010;NSData&#30340;&#21442;&#25968;,&#23558;query&#36716;&#21270;&#25104;NSData&#10;            [mutableRequest setHTTPBody:[query dataUsingEncoding:self.stringEncoding]];&#10;        &#125;&#10;    &#125;&#10; &#10;    return mutableRequest;&#10;&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">//&#29992;&#20110;AFURLRequestSerialization&#20869;&#37096;&#35843;&#29992;&#30340;&#26041;&#27861;&#10;static NSString * AFQueryStringFromParametersWithEncoding(NSDictionary *parameters, NSStringEncoding stringEncoding) &#123;&#10; &#10;    NSMutableArray *mutablePairs = [NSMutableArray array];&#10;//AFQueryStringPair&#26159;&#23553;&#35013;&#30340;&#38190;&#20540;&#23545;&#23545;&#35937;,&#20027;&#35201;&#26159;&#23558;dictionary&#20013;&#30340;&#38190;&#20540;&#23545;&#36716;&#21270;&#25104;query &#10;//string&#24418;&#24335;&#65292;&#21253;&#25324;&#19968;&#20123;&#29305;&#27530;&#23383;&#31526;&#30340;&#32534;&#30721;&#10;//AFQueryStringPairsFromDictionary&#23558;dictionary&#36716;&#21270;&#25104;AFQueryStringPair&#38598;&#21512;&#10;    for (AFQueryStringPair *pair in AFQueryStringPairsFromDictionary(parameters)) &#123;&#10; &#10;        [mutablePairs addObject:[pair URLEncodedStringValueWithEncoding:stringEncoding]];&#10; &#10;    &#125;&#10;    return [mutablePairs componentsJoinedByString:@&#34;&#38;&#34;];&#10; &#10;&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- (NSString *)URLEncodedStringValueWithEncoding:(NSStringEncoding)stringEncoding &#123;&#10;//&#30896;&#21040;nil&#25110;&#32773;NSNULL&#36793;&#30028;&#20540;&#30340;&#22788;&#29702;&#10;    if (!self.value || [self.value isEqual:[NSNull null]]) &#123;&#10;        return AFPercentEscapedQueryStringKeyFromStringWithEncoding([self.field&#10;         description], stringEncoding);&#10;    &#125; else &#123;&#10;        return [NSString stringWithFormat:@&#34;%@=%@&#34;, AFPercentEscapedQueryStringKeyFromStringWithEncoding([self.field &#10;            description], stringEncoding), AFPercentEscapedQueryStringValueFromStringWithEncoding([self.value &#10;                description], stringEncoding)];&#10;    &#125;&#10;&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">//&#20027;&#35201;&#35843;&#29992;foundation&#20989;&#25968;CFURLCreateStringByAddingPercentEscapes&#65292;&#23427;&#20027;&#35201;&#26159;&#23558;querystri&#10;//ng&#20013;&#30340;&#29305;&#27530;&#23383;&#31526;(&#38;,?)&#32534;&#30721;&#25104;&#8220;%+ASCII&#8221; &#24418;&#24335;&#12290;&#26681;&#25454;&#25991;&#26723;&#65292;&#24314;&#35758;&#20351;&#29992;NSString &#10;//stringByAddingPercentEncodingWithAllowedCharacters:]&#26041;&#27861;&#65292;&#36825;&#20010;&#26041;&#27861;&#20351;&#29992;UTF-8 encoding&#12290;&#10;static NSString * AFPercentEscapedQueryStringValueFromStringWithEncoding(&#10;    NSString *string, NSStringEncoding encoding) &#123;&#10;    return (__bridge_transfer  NSString *)CFURLCreateStringByAddingPercentEscapes(kCFAllocatorDefault, (__bridge &#10;        CFStringRef)string, NULL, (__bridge CFStringRef)kAFCharactersToBeEscapedInQueryString, &#10;        CFStringConvertNSStringEncodingToEncoding(encoding));&#10;&#125;</span><br></pre></td></tr></table></figure>
<h3 id="AFStreamingMutipartFormData"><a href="#AFStreamingMutipartFormData" class="headerlink" title="AFStreamingMutipartFormData"></a>AFStreamingMutipartFormData</h3><p>先看一个mutipart/form-data格式的请求</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">POST http://www.example.com HTTP/1.1&#10;Content-Type:multipart/form-data; boundary=----WebKitFormBoundaryrGKCBY7qhFd3TrwA&#10; &#10;------WebKitFormBoundaryrGKCBY7qhFd3TrwA&#10;Content-Disposition: form-data; name=&#34;text&#34;&#10; &#10;title&#10;------WebKitFormBoundaryrGKCBY7qhFd3TrwA&#10;Content-Disposition: form-data; name=&#34;file&#34;; filename=&#34;chrome.png&#34;&#10;Content-Type: image/png&#10; &#10;PNG ... content of chrome.png ...&#10;------WebKitFormBoundaryrGKCBY7qhFd3TrwA--</span><br></pre></td></tr></table></figure>
<ol>
<li>它的Content-Type包含两部分，第一部分是multipart/form-data,第二部分是boundary, boundary一般是随机生成的，保持唯一即可。上面还需要有content-length，图里面没有。</li>
<li>每个参数的部分都有content-disposition，并且以–boundary开头,最后一个参数以–boundary–结尾。</li>
</ol>
<p>AFNetworking通过AFStreamingMutipartFormData处理multipart/form-data格式的POST请求,它通过NSInputStream来构建http请求的body。每个参数的信息封装到了AFHTTPBodyPart中，所有的参数信息封装在AFMulipartBodyStream中。AFHTTPBodyPart中有NSInputStream对象用来将每个参数的写入到body，而AFMutipartBodyStream继承子NSInputStream处理所有参数的写入到body。其结构示意如下：</p>
<p><img src="http://7xqgnx.com1.z0.glb.clouddn.com/AFNetworkingArch.png" alt="AFNetworkingArch"></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">//&#22788;&#29702;multilpart/form-data(POST)&#35831;&#27714;&#10;- (NSMutableURLRequest *)multipartFormRequestWithMethod:(NSString *)method&#10; &#10;                                              URLString:(NSString *)URLString&#10; &#10;                                             parameters:(NSDictionary *)parameters&#10; &#10;                              constructingBodyWithBlock:(void (^)(id &#60;AFMultipartFormData&#62; formData))block&#10; &#10;                                                  error:(NSError *__autoreleasing *)error&#10; &#10;&#123;&#10;    NSParameterAssert(method);&#10; &#10;    NSParameterAssert(![method isEqualToString:@&#34;GET&#34;] &#38;&#38; ![method isEqualToString:@&#34;HEAD&#34;]);&#10;//&#36825;&#37324;parameters&#20256;&#30340;&#26159;nil&#65292;&#22240;&#20026;&#24403;&#21069;&#26684;&#24335;(mutilpart/form-data)&#10;//&#38656;&#35201;&#30001;AFStreamingMulitpartFormData&#21435;&#26500;&#24314;&#21442;&#25968;&#12290;&#10;    NSMutableURLRequest *mutableRequest = [self requestWithMethod:method &#10;    URLString:URLString parameters:nil error:error];&#10; &#10;    __block AFStreamingMultipartFormData *formData = [[AFStreamingMultipartFormData alloc] initWithURLRequest:mutableRequest &#10;    stringEncoding:NSUTF8StringEncoding];&#10; &#10;    if (parameters) &#123;&#10; &#10;        for (AFQueryStringPair *pair in AFQueryStringPairsFromDictionary(parameters)) &#123;&#10;//&#23545;&#20110;dictionary&#30340;&#21442;&#25968;&#65292;&#30452;&#25509;&#23558;&#23427;&#30340;&#20540;&#36716;&#25104;NSData&#22788;&#29702;&#65292;&#10;            NSData *data = nil;&#10; &#10;            if ([pair.value isKindOfClass:[NSData class]]) &#123;&#10; &#10;                data = pair.value;&#10; &#10;            &#125; else if ([pair.value isEqual:[NSNull null]]) &#123;&#10; &#10;                data = [NSData data];&#10; &#10;            &#125; else &#123;&#10; &#10;                data = [[pair.value description] dataUsingEncoding:self.stringEncoding];&#10; &#10;            &#125;&#10; &#10;            if (data) &#123;&#10;//AFStreamingMultipartFormData&#23545;&#35937;&#30340;appendPartWithFormData&#23558;&#38190;&#20540;&#23545;&#36716;&#21270;&#25104;AFHTTPBodyP&#10;//art&#24182;&#19988;&#25918;&#21040;AFMultipartBodyStream&#38598;&#21512;&#20013;&#12290;&#10;                [formData appendPartWithFormData:data name:[pair.field description]];&#10; &#10;            &#125;&#10; &#10;        &#125;&#10; &#10;    &#125;&#10; &#10;    if (block) &#123;&#10;//&#24403;&#21069;block&#29992;&#26469;&#22788;&#29702;&#38750;dictionary&#30340;&#24773;&#20917;&#65292;&#27604;&#22914;&#21442;&#25968;&#21487;&#33021;&#26159;&#19968;&#20010;NSURL,&#25110;&#32773;&#30452;&#25509;&#23601;&#26159;&#19968;&#20010;NSInputStream&#12290;&#10;        block(formData);&#10; &#10;    &#125;&#10;//AFStreamingMultipartFormData&#30340;requestByFinalizingMultipartFormData&#20027;&#35201;&#26159;&#35774;&#32622;cont&#10;//ent-Type&#21644;content-Length&#20197;&#21450;boundary&#10;    return [formData requestByFinalizingMultipartFormData];&#10; &#10;&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- (NSMutableURLRequest *)requestByFinalizingMultipartFormData &#123;&#10; &#10;    if ([self.bodyStream isEmpty]) &#123;&#10; &#10;        return self.request;&#10; &#10;    &#125;&#10; &#10;    // &#35774;&#32622;boundary&#10; &#10;    [self.bodyStream setInitialAndFinalBoundaries];&#10; &#10;//&#23558;AFStreamingMultipartFormData&#30340;AFMultipartBodyStream&#35774;&#32622;&#21040;http body stream&#19978;&#10;    [self.request setHTTPBodyStream:self.bodyStream];&#10; &#10;    [self.request setValue:[NSString stringWithFormat:@&#34;multipart/form-data; &#10;    boundary=%@&#34;, self.boundary] forHTTPHeaderField:@&#34;Content-Type&#34;];&#10; &#10;    [self.request setValue:[NSString stringWithFormat:@&#34;%llu&#34;, [self.bodyStream&#10;     contentLength]] forHTTPHeaderField:@&#34;Content-Length&#34;];&#10; &#10;    return self.request;&#10; &#10;&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- (void)setInitialAndFinalBoundaries &#123;&#10; &#10;    if ([self.HTTPBodyParts count] &#62; 0) &#123;&#10; &#10;        for (AFHTTPBodyPart *bodyPart in self.HTTPBodyParts) &#123;&#10; &#10;            bodyPart.hasInitialBoundary = NO;&#10; &#10;            bodyPart.hasFinalBoundary = NO;&#10; &#10;        &#125;&#10;//&#35774;&#32622;boundary&#30340;&#22836;&#10;        [[self.HTTPBodyParts objectAtIndex:0] setHasInitialBoundary:YES];&#10;//&#35774;&#32622;boundary&#30340;&#23614;&#10;        [[self.HTTPBodyParts lastObject] setHasFinalBoundary:YES];&#10; &#10;    &#125;&#10; &#10;&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">//&#20027;&#35201;&#26159;&#35774;&#32622;&#27599;&#20010;&#21442;&#25968;&#37096;&#20998;&#30340;content-disposition&#10;- (void)appendPartWithFormData:(NSData *)data&#10;                          name:(NSString *)name&#10; &#10;&#123;&#10;    NSParameterAssert(name);&#10; &#10;    NSMutableDictionary *mutableHeaders = [NSMutableDictionary dictionary];&#10; &#10;    [mutableHeaders setValue:[NSString stringWithFormat:@&#34;form-data; name=\&#34;%@&#10;    \&#34;&#34;, name] forKey:@&#34;Content-Disposition&#34;];&#10; &#10;    [self appendPartWithHeaders:mutableHeaders body:data];&#10; &#10;&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">//&#26500;&#24314;AFHTTPBodyPart&#23545;&#35937;,&#36825;&#31181;&#24773;&#20917;&#19979;&#65292;AFHTTPBody&#23545;&#35937;&#30340;body&#37117;&#26159;nsdata&#31867;&#22411;&#10;- (void)appendPartWithHeaders:(NSDictionary *)headers&#10;                         body:(NSData *)body&#10; &#10;&#123;&#10;    NSParameterAssert(body);&#10; &#10;    AFHTTPBodyPart *bodyPart = [[AFHTTPBodyPart alloc] init];&#10; &#10;    bodyPart.stringEncoding = self.stringEncoding;&#10; &#10;    bodyPart.headers = headers;&#10; &#10;    bodyPart.boundary = self.boundary;&#10; &#10;    bodyPart.bodyContentLength = [body length];&#10; &#10;    bodyPart.body = body;&#10; &#10;    [self.bodyStream appendHTTPBodyPart:bodyPart];&#10; &#10;&#125;</span><br></pre></td></tr></table></figure>
<p>除了NSData，还可以传入NSInputStream,NSURL去构建AFHTTPBodyPart对象，过程和NSData类似，设置Content-disposition和Content-Type，再通过data去构建AFHTTPBodyPart。</p>
<h3 id="AFMultipartBodyStream"><a href="#AFMultipartBodyStream" class="headerlink" title="AFMultipartBodyStream"></a>AFMultipartBodyStream</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- (NSInteger)read:(uint8_t *)buffer&#10; &#10;        maxLength:(NSUInteger)length&#10;&#123;&#10;//AFStreamingMutipartFormData&#23558;AFMultipartBodyStream&#35774;&#32622;&#21040;NSUrlRequest&#30340;httpbodys&#10;//tream&#20043;&#21518;&#65292;foundation&#20250;&#33258;&#21160;&#35843;&#29992;read:maxLength:&#26041;&#27861;&#65292;&#25913;&#26041;&#27861;&#23454;&#29616;&#20013;&#36941;&#21382;&#20043;&#21069;&#26500;&#24314;&#30340;&#25152;&#26377;AFHTTP&#10;//BodyPart&#23545;&#35937;&#65292;&#20998;&#21035;&#35843;&#29992;&#23427;&#20204;&#30340;read:maxLength:&#26041;&#27861;&#26469;&#33719;&#21462;&#25968;&#25454;&#12290;&#10;&#10;&#10;    if ([self streamStatus] == NSStreamStatusClosed) &#123;&#10; &#10;        return 0;&#10; &#10;    &#125;&#10; &#10;    NSInteger totalNumberOfBytesRead = 0;&#10; &#10;#pragma clang diagnostic push&#10; &#10;#pragma clang diagnostic ignored &#34;-Wgnu&#34;&#10; &#10;    while ((NSUInteger)totalNumberOfBytesRead &#60; MIN(length, self.&#10;        numberOfBytesInPacket)) &#123;&#10; &#10;        if (!self.currentHTTPBodyPart || ![self.currentHTTPBodyPart &#10;            hasBytesAvailable]) &#123;&#10; &#10;            if (!(self.currentHTTPBodyPart = [self.HTTPBodyPartEnumerator &#10;                nextObject])) &#123;&#10; &#10;                break;&#10; &#10;            &#125;&#10; &#10;        &#125; else &#123;&#10; &#10;            NSUInteger maxLength = length - (NSUInteger)totalNumberOfBytesRead;&#10; &#10;            NSInteger numberOfBytesRead = [self.currentHTTPBodyPart read:&#38;&#10;            buffer[totalNumberOfBytesRead] maxLength:maxLength];&#10; &#10;            if (numberOfBytesRead == -1) &#123;&#10; &#10;                self.streamError = self.currentHTTPBodyPart.inputStream.&#10;                streamError;&#10; &#10;                break;&#10; &#10;            &#125; else &#123;&#10; &#10;                totalNumberOfBytesRead += numberOfBytesRead;&#10; &#10;                if (self.delay &#62; 0.0f) &#123;&#10; &#10;                    [NSThread sleepForTimeInterval:self.delay];&#10; &#10;                &#125;&#10; &#10;            &#125;&#10; &#10;        &#125;&#10; &#10;    &#125;&#10;    return totalNumberOfBytesRead;&#10; &#10;&#125;</span><br></pre></td></tr></table></figure>
<h3 id="AFHTTPBodyPart"><a href="#AFHTTPBodyPart" class="headerlink" title="AFHTTPBodyPart"></a>AFHTTPBodyPart</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">//&#26681;&#25454;body&#31867;&#22411;&#29983;&#25104;&#23545;&#24212;&#30340;inputStream&#10;- (NSInputStream *)inputStream &#123;&#10; &#10;    if (!_inputStream) &#123;&#10; &#10;        if ([self.body isKindOfClass:[NSData class]]) &#123;&#10; &#10;            _inputStream = [NSInputStream inputStreamWithData:self.body];&#10; &#10;        &#125; else if ([self.body isKindOfClass:[NSURL class]]) &#123;&#10; &#10;            _inputStream = [NSInputStream inputStreamWithURL:self.body];&#10; &#10;        &#125; else if ([self.body isKindOfClass:[NSInputStream class]]) &#123;&#10; &#10;            _inputStream = self.body;&#10; &#10;        &#125; else &#123;&#10;            _inputStream = [NSInputStream inputStreamWithData:[NSData data]];&#10;        &#125;&#10;    &#125;&#10; &#10;    return _inputStream;&#10;&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- (NSInteger)read:(uint8_t *)buffer&#10; &#10;        maxLength:(NSUInteger)length&#10; &#10;&#123;&#10; &#10;    NSInteger totalNumberOfBytesRead = 0;&#10;    if (_phase == AFEncapsulationBoundaryPhase) &#123;&#10;//boundary&#37096;&#20998;&#65292;&#36716;&#25104;NSData&#10;        NSData *encapsulationBoundaryData = [([self hasInitialBoundary] ? &#10;            AFMultipartFormInitialBoundary(self.boundary) : &#10;            AFMultipartFormEncapsulationBoundary(self.boundary)) &#10;            dataUsingEncoding:self.stringEncoding];&#10; &#10;        totalNumberOfBytesRead += [self readData:encapsulationBoundaryData &#10;        intoBuffer:&#38;buffer[totalNumberOfBytesRead] maxLength:(length - (&#10;            NSUInteger)totalNumberOfBytesRead)];&#10; &#10;    &#125;&#10;    if (_phase == AFHeaderPhase) &#123;&#10;//content-disposition&#21644;content-length,&#36716;&#25104;NSData&#10;        NSData *headersData = [[self stringForHeaders] dataUsingEncoding:self.&#10;        stringEncoding];&#10; &#10;        totalNumberOfBytesRead += [self readData:headersData intoBuffer:&#38;buffer&#10;        [totalNumberOfBytesRead] maxLength:(length - (NSUInteger)&#10;        totalNumberOfBytesRead)];&#10; &#10;    &#125;&#10; &#10;    if (_phase == AFBodyPhase) &#123;&#10;        NSInteger numberOfBytesRead = 0;&#10;//&#27599;&#20010;AFHTTPBodyPart&#30340;body&#37096;&#20998;&#65292;&#20063;&#23601;&#26159;&#23454;&#38469;&#20256;&#36755;&#30340;&#25968;&#25454;&#37096;&#20998;&#65292;&#37117;&#36890;&#36807;&#22312;inputStream&#26041;&#27861;&#37324;&#26681;&#25454;&#20854;&#23454;&#10;//&#38469;&#25968;&#25454;&#31867;&#22411;&#36716;&#21270;&#25104;&#20102;NSInputStream&#31867;&#22411;&#23545;&#35937;&#65292;&#25152;&#20197;&#36825;&#37324;&#21482;&#38656;&#35201;&#35843;&#29992;foundation&#33258;&#24102;&#30340;read:maxLength&#26041;&#27861;&#23601;&#34892;&#20102;&#12290;&#10;        numberOfBytesRead = [self.inputStream read:&#38;buffer[&#10;        totalNumberOfBytesRead] maxLength:(length - (NSUInteger)&#10;        totalNumberOfBytesRead)];&#10; &#10;        if (numberOfBytesRead == -1) &#123;&#10; &#10;            return -1;&#10; &#10;        &#125; else &#123;&#10; &#10;            totalNumberOfBytesRead += numberOfBytesRead;&#10;            if ([self.inputStream streamStatus] &#62;= NSStreamStatusAtEnd) &#123;&#10; &#10;                [self transitionToNextPhase];&#10;            &#125;&#10;        &#125;&#10;    &#125;&#10; &#10;    if (_phase == AFFinalBoundaryPhase) &#123;&#10;//&#22914;&#26524;&#24403;&#21069;AFHTTPBodyPart&#26159;&#26368;&#21518;&#19968;&#20010;&#21442;&#25968;&#65292;&#37027;&#20040;&#20250;&#27604;&#20854;&#20182;&#21442;&#25968;&#22810;&#19968;&#20010;--boundary--&#30340;&#37096;&#20998;,&#36716;&#25104;NSData&#10;        NSData *closingBoundaryData = ([self hasFinalBoundary] ? [&#10;            AFMultipartFormFinalBoundary(self.boundary) dataUsingEncoding:self.&#10;            stringEncoding] : [NSData data]);&#10; &#10;        totalNumberOfBytesRead += [self readData:closingBoundaryData intoBuffer&#10;        :&#38;buffer[totalNumberOfBytesRead] maxLength:(length - (NSUInteger)&#10;        totalNumberOfBytesRead)];&#10; &#10;    &#125;&#10; &#10;    return totalNumberOfBytesRead;&#10; &#10;&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">//&#23558;data&#35835;&#20837;buffer&#20013;&#10;- (NSInteger)readData:(NSData *)data&#10; &#10;           intoBuffer:(uint8_t *)buffer&#10; &#10;            maxLength:(NSUInteger)length&#10; &#10;&#123;&#10; &#10;#pragma clang diagnostic push&#10; &#10;#pragma clang diagnostic ignored &#34;-Wgnu&#34;&#10;/*&#27809;&#26377;&#26126;&#30333;&#20026;&#20160;&#20040;&#35835;data&#30340;&#26102;&#20505;range&#20026;&#20160;&#20040;&#35201;&#20174;_phaseReadOffset&#24320;&#22987;&#65292;&#19981;&#24212;&#35813;&#26159;&#20174;0&#24320;&#22987;&#21527;&#65292;&#22240;&#20026;&#27599;&#27425;&#10;&#37117;&#26159;&#19968;&#20010;&#20840;&#26032;&#30340;data*/&#10;    NSRange range = NSMakeRange((NSUInteger)_phaseReadOffset, MIN([data length]&#10;     - ((NSUInteger)_phaseReadOffset), length));&#10;//&#23558;data&#20013;range&#33539;&#22260;&#20043;&#20869;&#30340;&#25968;&#25454;&#22797;&#21046;&#21040;buffer&#37324;&#10;    [data getBytes:buffer range:range];&#10; &#10;#pragma clang diagnostic pop&#10; &#10;    _phaseReadOffset += range.length;&#10; &#10;    if (((NSUInteger)_phaseReadOffset) &#62;= [data length]) &#123;&#10; &#10;        [self transitionToNextPhase];&#10; &#10;    &#125;&#10;    return (NSInteger)range.length;&#10; &#10;&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">//&#24207;&#21015;&#21270;AFHTTPBodyPart&#30340;headers&#37096;&#20998;&#10;- (NSString *)stringForHeaders &#123;&#10;    NSMutableString *headerString = [NSMutableString string];&#10; &#10;    for (NSString *field in [self.headers allKeys]) &#123;&#10; &#10;        [headerString appendString:[NSString stringWithFormat:@&#34;%@: %@%@&#34;, &#10;        field, [self.headers valueForKey:field], kAFMultipartFormCRLF]];&#10; &#10;    &#125;&#10;    [headerString appendString:kAFMultipartFormCRLF];&#10;    return [NSString stringWithString:headerString];&#10; &#10;&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">//&#35745;&#31639;&#27599;&#20010;AFHTTPBodyPart&#30340;&#20869;&#23481;&#38271;&#24230;&#65292;&#21253;&#25324;&#20256;&#36755;&#21442;&#25968;&#65292;&#35831;&#27714;&#22836;&#21644;boundary&#20449;&#24687;,&#22312;AFMultiStream&#37324;&#20250;&#10;//&#23558;&#25152;&#26377;&#30340;AFHTTPBodyPart&#30340;content-length&#21152;&#36215;&#26469;&#65292;&#20570;&#20026;&#25972;&#20010;POST&#35831;&#27714;&#20307;&#30340;content-length&#12290;&#10;- (unsigned long long)contentLength &#123;&#10;    unsigned long long length = 0;&#10;//boundary&#10;    NSData *encapsulationBoundaryData = [([self hasInitialBoundary] ? &#10;        AFMultipartFormInitialBoundary(self.boundary) : &#10;    AFMultipartFormEncapsulationBoundary(self.boundary)) dataUsingEncoding:self&#10;    .stringEncoding];&#10;    length += [encapsulationBoundaryData length];&#10;//headers&#10;    NSData *headersData = [[self stringForHeaders] dataUsingEncoding:self.&#10;    stringEncoding];&#10;    length += [headersData length];&#10;//data&#10;    length += _bodyContentLength;&#10;//close boudary&#10;    NSData *closingBoundaryData = ([self hasFinalBoundary] ? [&#10;        AFMultipartFormFinalBoundary(self.boundary) dataUsingEncoding:self.&#10;    stringEncoding] : [NSData data]);&#10;    length += [closingBoundaryData length];&#10;    return length;&#10; &#10;&#125;</span><br></pre></td></tr></table></figure></div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://yoursite.com/2016/10/13/AFNetworking-RequestSerializer/" data-id="cj5jc89u0001o1wcvww7hovnb" class="article-share-link">分享</a><div class="tags"><a href="/tags/源码分析/">源码分析</a></div><div class="post-nav"><a href="/2016/10/13/AFNetworking-ResponseSerializer/" class="pre">AFNetworking-ResponseSerializer</a><a href="/2016/01/26/CFRunLoop/" class="next">CFRunLoop</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://yoursite.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Tech/">Tech</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Tools/">Tools</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/源码分析/" style="font-size: 15px;">源码分析</a> <a href="/tags/hexo/" style="font-size: 15px;">hexo</a> <a href="/tags/iOS/" style="font-size: 15px;">iOS</a> <a href="/tags/git/" style="font-size: 15px;">git</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/09/12/Method Swizzle的危机/">Method Swizzle的危机</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/25/GitHook/">Git Hook</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/13/Method Swizzle中的对象模型/">Method Swizzle中的对象模型</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/19/iOS定位库-INTULocationRequest/">iOS定位库-INTULocationRequest</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/10/13/AFNetworking-NSURLConnection/">AFNetworking-NSURLConnection</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/10/13/AFNetWorking—NSURLSession/">AFNetWorking—NSURLSession</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/10/13/AFNetworking-ResponseSerializer/">AFNetworking-ResponseSerializer</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/10/13/AFNetworking-RequestSerializer/">AFNetworking-RequestSerializer</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/26/CFRunLoop/">CFRunLoop</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/26/RunLoop介绍/">RunLoop介绍</a></li></ul></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2017 <a href="/." rel="nofollow">一只独来独往的水鸟.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>
<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="博客"><title>AFNetworking-RequestSerializer | 一只独来独往的水鸟</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/6.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">AFNetworking-RequestSerializer</h1><a id="logo" href="/.">一只独来独往的水鸟</a><p class="description">iOS</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">AFNetworking-RequestSerializer</h1><div class="post-meta">Oct 13, 2016<span> | </span><span class="category"><a href="/categories/Tech/">Tech</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span></div><div class="post-content"><h2 id="概况介绍："><a href="#概况介绍：" class="headerlink" title="概况介绍："></a>概况介绍：</h2><p>这篇主要介绍AFNetworking中请求参数序列化的部分,具体代码在AFURLRequestSerialization中。AFURLRequestSerialization包含四部分:</p>
<ul>
<li>AFHTTPRequestSerializaiton</li>
<li>AFJSONRequestSerializer</li>
<li>AFPropertyListRequestSerializer</li>
</ul>
<p>AFHTTPRequestSerialization主要是设置http请求头,设置超时时间,BA认证，处理用户名密码登陆等等。主要功能分3大块：</p>
<ol>
<li>处理所有的GET,HEAD,DELETE请求</li>
<li>处理content-type是application/x-www-form-urlencoded类型的POST请求</li>
<li>处理content-type是multipart/form-data类型的POST请求，请求的构建是通过AFStreamingMultipartFormData对象实现的。</li>
</ol>
<p>AFJSONRequestSerializer继承自AFHTTPRequestSerialization类，使用NSJSONSerialization序列化json格式(application/json)的参数，将一个Dictionary对象转化成NSData，它只处理POST请求。</p>
<p>AFPropertyListRequestSerializer也继承了AFHTTPRequestSerialization类，使用NSPropertyListSerialization对象来序列化xml格式(application/x-plist)的参数，它也只处理POST请求。</p>
<p>综上所述，AFHTTPRequestSerialization是最重要也是最复杂的部分，源码也主要针对这部分做分析。</p>
<h2 id="源码分析："><a href="#源码分析：" class="headerlink" title="源码分析："></a>源码分析：</h2><h3 id="参数序列化和编码"><a href="#参数序列化和编码" class="headerlink" title="参数序列化和编码"></a>参数序列化和编码</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">- (NSURLRequest *)requestBySerializingRequest:(NSURLRequest *)request</span><br><span class="line"> </span><br><span class="line">                               withParameters:(id)parameters</span><br><span class="line"> </span><br><span class="line">                                        error:(NSError *__autoreleasing *)error</span><br><span class="line"> </span><br><span class="line">&#123;</span><br><span class="line"> </span><br><span class="line">    NSParameterAssert(request);</span><br><span class="line"> </span><br><span class="line">    NSMutableURLRequest *mutableRequest = [request mutableCopy];</span><br><span class="line">//设置http请求头</span><br><span class="line">    [self.HTTPRequestHeaders enumerateKeysAndObjectsUsingBlock:^(id field, id </span><br><span class="line">        value, BOOL * __unused stop) &#123;</span><br><span class="line"> </span><br><span class="line">        if (![request valueForHTTPHeaderField:field]) &#123;</span><br><span class="line"> </span><br><span class="line">            [mutableRequest setValue:value forHTTPHeaderField:field];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;];</span><br><span class="line">//序列化参数</span><br><span class="line">    if (parameters) &#123;</span><br><span class="line"> </span><br><span class="line">        NSString *query = nil;</span><br><span class="line">//queryStringSerilization是一个block，主要是用来自定义参数序列化的逻辑，返回一个序列化完成的结果</span><br><span class="line">        if (self.queryStringSerialization) &#123;</span><br><span class="line"> </span><br><span class="line">            NSError *serializationError;</span><br><span class="line"> </span><br><span class="line">            query = self.queryStringSerialization(request, parameters, &amp;</span><br><span class="line">                serializationError);</span><br><span class="line"> </span><br><span class="line">            if (serializationError) &#123;</span><br><span class="line"> </span><br><span class="line">                if (error) &#123;</span><br><span class="line"> </span><br><span class="line">                    *error = serializationError;</span><br><span class="line"> </span><br><span class="line">                &#125;</span><br><span class="line"> </span><br><span class="line">                return nil;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line"> </span><br><span class="line">            switch (self.queryStringSerializationStyle) &#123;</span><br><span class="line">//使用AFNetworking默认的格式序列化，a=1&amp;b=2这种</span><br><span class="line">                case AFHTTPRequestQueryStringDefaultStyle:</span><br><span class="line">//这里parameters是一个dictionary对象,stringEncoding是给httpBody设置data的时候字符</span><br><span class="line">//串的编码格式</span><br><span class="line">                    query = AFQueryStringFromParametersWithEncoding(parameters, self.stringEncoding);</span><br><span class="line"> </span><br><span class="line">                    break;</span><br><span class="line"> </span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">        &#125;</span><br><span class="line">//HTTPMethodsEncodingParametersInURI定义了GET,DELETE,HEAD3种方法</span><br><span class="line">        if ([self.HTTPMethodsEncodingParametersInURI containsObject:[[request </span><br><span class="line">            HTTPMethod] uppercaseString]]) &#123;</span><br><span class="line"> </span><br><span class="line">            mutableRequest.URL = [NSURL URLWithString:[[mutableRequest.URL absoluteString] stringByAppendingFormat:mutableRequest.URL.query ? </span><br><span class="line">            @&quot;&amp;%@&quot; : @&quot;?%@&quot;, query]];</span><br><span class="line"> </span><br><span class="line">        &#125; else &#123;</span><br><span class="line">//POST</span><br><span class="line">            if (![mutableRequest valueForHTTPHeaderField:@&quot;Content-Type&quot;]) &#123;</span><br><span class="line"> </span><br><span class="line">                [mutableRequest setValue:@&quot;application/x-www-form-urlencoded&quot; forHTTPHeaderField:@&quot;Content-Type&quot;];</span><br><span class="line"> </span><br><span class="line">            &#125;</span><br><span class="line">//setHTTPBody接受一个NSData的参数,将query转化成NSData</span><br><span class="line">            [mutableRequest setHTTPBody:[query dataUsingEncoding:self.stringEncoding]];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    return mutableRequest;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">//用于AFURLRequestSerialization内部调用的方法</span><br><span class="line">static NSString * AFQueryStringFromParametersWithEncoding(NSDictionary *parameters, NSStringEncoding stringEncoding) &#123;</span><br><span class="line"> </span><br><span class="line">    NSMutableArray *mutablePairs = [NSMutableArray array];</span><br><span class="line">//AFQueryStringPair是封装的键值对对象,主要是将dictionary中的键值对转化成query </span><br><span class="line">//string形式，包括一些特殊字符的编码</span><br><span class="line">//AFQueryStringPairsFromDictionary将dictionary转化成AFQueryStringPair集合</span><br><span class="line">    for (AFQueryStringPair *pair in AFQueryStringPairsFromDictionary(parameters)) &#123;</span><br><span class="line"> </span><br><span class="line">        [mutablePairs addObject:[pair URLEncodedStringValueWithEncoding:stringEncoding]];</span><br><span class="line"> </span><br><span class="line">    &#125;</span><br><span class="line">    return [mutablePairs componentsJoinedByString:@&quot;&amp;&quot;];</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">- (NSString *)URLEncodedStringValueWithEncoding:(NSStringEncoding)stringEncoding &#123;</span><br><span class="line">//碰到nil或者NSNULL边界值的处理</span><br><span class="line">    if (!self.value || [self.value isEqual:[NSNull null]]) &#123;</span><br><span class="line">        return AFPercentEscapedQueryStringKeyFromStringWithEncoding([self.field</span><br><span class="line">         description], stringEncoding);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        return [NSString stringWithFormat:@&quot;%@=%@&quot;, AFPercentEscapedQueryStringKeyFromStringWithEncoding([self.field </span><br><span class="line">            description], stringEncoding), AFPercentEscapedQueryStringValueFromStringWithEncoding([self.value </span><br><span class="line">                description], stringEncoding)];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">//主要调用foundation函数CFURLCreateStringByAddingPercentEscapes，它主要是将querystri</span><br><span class="line">//ng中的特殊字符(&amp;,?)编码成“%+ASCII” 形式。根据文档，建议使用NSString </span><br><span class="line">//stringByAddingPercentEncodingWithAllowedCharacters:]方法，这个方法使用UTF-8 encoding。</span><br><span class="line">static NSString * AFPercentEscapedQueryStringValueFromStringWithEncoding(</span><br><span class="line">    NSString *string, NSStringEncoding encoding) &#123;</span><br><span class="line">    return (__bridge_transfer  NSString *)CFURLCreateStringByAddingPercentEscapes(kCFAllocatorDefault, (__bridge </span><br><span class="line">        CFStringRef)string, NULL, (__bridge CFStringRef)kAFCharactersToBeEscapedInQueryString, </span><br><span class="line">        CFStringConvertNSStringEncodingToEncoding(encoding));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="AFStreamingMutipartFormData"><a href="#AFStreamingMutipartFormData" class="headerlink" title="AFStreamingMutipartFormData"></a>AFStreamingMutipartFormData</h3><p>先看一个mutipart/form-data格式的请求</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">POST http://www.example.com HTTP/1.1</span><br><span class="line">Content-Type:multipart/form-data; boundary=----WebKitFormBoundaryrGKCBY7qhFd3TrwA</span><br><span class="line"> </span><br><span class="line">------WebKitFormBoundaryrGKCBY7qhFd3TrwA</span><br><span class="line">Content-Disposition: form-data; name=&quot;text&quot;</span><br><span class="line"> </span><br><span class="line">title</span><br><span class="line">------WebKitFormBoundaryrGKCBY7qhFd3TrwA</span><br><span class="line">Content-Disposition: form-data; name=&quot;file&quot;; filename=&quot;chrome.png&quot;</span><br><span class="line">Content-Type: image/png</span><br><span class="line"> </span><br><span class="line">PNG ... content of chrome.png ...</span><br><span class="line">------WebKitFormBoundaryrGKCBY7qhFd3TrwA--</span><br></pre></td></tr></table></figure>
<ol>
<li>它的Content-Type包含两部分，第一部分是multipart/form-data,第二部分是boundary, boundary一般是随机生成的，保持唯一即可。上面还需要有content-length，图里面没有。</li>
<li>每个参数的部分都有content-disposition，并且以–boundary开头,最后一个参数以–boundary–结尾。</li>
</ol>
<p>AFNetworking通过AFStreamingMutipartFormData处理multipart/form-data格式的POST请求,它通过NSInputStream来构建http请求的body。每个参数的信息封装到了AFHTTPBodyPart中，所有的参数信息封装在AFMulipartBodyStream中。AFHTTPBodyPart中有NSInputStream对象用来将每个参数的写入到body，而AFMutipartBodyStream继承子NSInputStream处理所有参数的写入到body。其结构示意如下：</p>
<p><img src="http://7xqgnx.com1.z0.glb.clouddn.com/AFNetworkingArch.png" alt="AFNetworkingArch"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">//处理multilpart/form-data(POST)请求</span><br><span class="line">- (NSMutableURLRequest *)multipartFormRequestWithMethod:(NSString *)method</span><br><span class="line"> </span><br><span class="line">                                              URLString:(NSString *)URLString</span><br><span class="line"> </span><br><span class="line">                                             parameters:(NSDictionary *)parameters</span><br><span class="line"> </span><br><span class="line">                              constructingBodyWithBlock:(void (^)(id &lt;AFMultipartFormData&gt; formData))block</span><br><span class="line"> </span><br><span class="line">                                                  error:(NSError *__autoreleasing *)error</span><br><span class="line"> </span><br><span class="line">&#123;</span><br><span class="line">    NSParameterAssert(method);</span><br><span class="line"> </span><br><span class="line">    NSParameterAssert(![method isEqualToString:@&quot;GET&quot;] &amp;&amp; ![method isEqualToString:@&quot;HEAD&quot;]);</span><br><span class="line">//这里parameters传的是nil，因为当前格式(mutilpart/form-data)</span><br><span class="line">//需要由AFStreamingMulitpartFormData去构建参数。</span><br><span class="line">    NSMutableURLRequest *mutableRequest = [self requestWithMethod:method </span><br><span class="line">    URLString:URLString parameters:nil error:error];</span><br><span class="line"> </span><br><span class="line">    __block AFStreamingMultipartFormData *formData = [[AFStreamingMultipartFormData alloc] initWithURLRequest:mutableRequest </span><br><span class="line">    stringEncoding:NSUTF8StringEncoding];</span><br><span class="line"> </span><br><span class="line">    if (parameters) &#123;</span><br><span class="line"> </span><br><span class="line">        for (AFQueryStringPair *pair in AFQueryStringPairsFromDictionary(parameters)) &#123;</span><br><span class="line">//对于dictionary的参数，直接将它的值转成NSData处理，</span><br><span class="line">            NSData *data = nil;</span><br><span class="line"> </span><br><span class="line">            if ([pair.value isKindOfClass:[NSData class]]) &#123;</span><br><span class="line"> </span><br><span class="line">                data = pair.value;</span><br><span class="line"> </span><br><span class="line">            &#125; else if ([pair.value isEqual:[NSNull null]]) &#123;</span><br><span class="line"> </span><br><span class="line">                data = [NSData data];</span><br><span class="line"> </span><br><span class="line">            &#125; else &#123;</span><br><span class="line"> </span><br><span class="line">                data = [[pair.value description] dataUsingEncoding:self.stringEncoding];</span><br><span class="line"> </span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">            if (data) &#123;</span><br><span class="line">//AFStreamingMultipartFormData对象的appendPartWithFormData将键值对转化成AFHTTPBodyP</span><br><span class="line">//art并且放到AFMultipartBodyStream集合中。</span><br><span class="line">                [formData appendPartWithFormData:data name:[pair.field description]];</span><br><span class="line"> </span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    if (block) &#123;</span><br><span class="line">//当前block用来处理非dictionary的情况，比如参数可能是一个NSURL,或者直接就是一个NSInputStream。</span><br><span class="line">        block(formData);</span><br><span class="line"> </span><br><span class="line">    &#125;</span><br><span class="line">//AFStreamingMultipartFormData的requestByFinalizingMultipartFormData主要是设置cont</span><br><span class="line">//ent-Type和content-Length以及boundary</span><br><span class="line">    return [formData requestByFinalizingMultipartFormData];</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">- (NSMutableURLRequest *)requestByFinalizingMultipartFormData &#123;</span><br><span class="line"> </span><br><span class="line">    if ([self.bodyStream isEmpty]) &#123;</span><br><span class="line"> </span><br><span class="line">        return self.request;</span><br><span class="line"> </span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    // 设置boundary</span><br><span class="line"> </span><br><span class="line">    [self.bodyStream setInitialAndFinalBoundaries];</span><br><span class="line"> </span><br><span class="line">//将AFStreamingMultipartFormData的AFMultipartBodyStream设置到http body stream上</span><br><span class="line">    [self.request setHTTPBodyStream:self.bodyStream];</span><br><span class="line"> </span><br><span class="line">    [self.request setValue:[NSString stringWithFormat:@&quot;multipart/form-data; </span><br><span class="line">    boundary=%@&quot;, self.boundary] forHTTPHeaderField:@&quot;Content-Type&quot;];</span><br><span class="line"> </span><br><span class="line">    [self.request setValue:[NSString stringWithFormat:@&quot;%llu&quot;, [self.bodyStream</span><br><span class="line">     contentLength]] forHTTPHeaderField:@&quot;Content-Length&quot;];</span><br><span class="line"> </span><br><span class="line">    return self.request;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">- (void)setInitialAndFinalBoundaries &#123;</span><br><span class="line"> </span><br><span class="line">    if ([self.HTTPBodyParts count] &gt; 0) &#123;</span><br><span class="line"> </span><br><span class="line">        for (AFHTTPBodyPart *bodyPart in self.HTTPBodyParts) &#123;</span><br><span class="line"> </span><br><span class="line">            bodyPart.hasInitialBoundary = NO;</span><br><span class="line"> </span><br><span class="line">            bodyPart.hasFinalBoundary = NO;</span><br><span class="line"> </span><br><span class="line">        &#125;</span><br><span class="line">//设置boundary的头</span><br><span class="line">        [[self.HTTPBodyParts objectAtIndex:0] setHasInitialBoundary:YES];</span><br><span class="line">//设置boundary的尾</span><br><span class="line">        [[self.HTTPBodyParts lastObject] setHasFinalBoundary:YES];</span><br><span class="line"> </span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">//主要是设置每个参数部分的content-disposition</span><br><span class="line">- (void)appendPartWithFormData:(NSData *)data</span><br><span class="line">                          name:(NSString *)name</span><br><span class="line"> </span><br><span class="line">&#123;</span><br><span class="line">    NSParameterAssert(name);</span><br><span class="line"> </span><br><span class="line">    NSMutableDictionary *mutableHeaders = [NSMutableDictionary dictionary];</span><br><span class="line"> </span><br><span class="line">    [mutableHeaders setValue:[NSString stringWithFormat:@&quot;form-data; name=\&quot;%@</span><br><span class="line">    \&quot;&quot;, name] forKey:@&quot;Content-Disposition&quot;];</span><br><span class="line"> </span><br><span class="line">    [self appendPartWithHeaders:mutableHeaders body:data];</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">//构建AFHTTPBodyPart对象,这种情况下，AFHTTPBody对象的body都是nsdata类型</span><br><span class="line">- (void)appendPartWithHeaders:(NSDictionary *)headers</span><br><span class="line">                         body:(NSData *)body</span><br><span class="line"> </span><br><span class="line">&#123;</span><br><span class="line">    NSParameterAssert(body);</span><br><span class="line"> </span><br><span class="line">    AFHTTPBodyPart *bodyPart = [[AFHTTPBodyPart alloc] init];</span><br><span class="line"> </span><br><span class="line">    bodyPart.stringEncoding = self.stringEncoding;</span><br><span class="line"> </span><br><span class="line">    bodyPart.headers = headers;</span><br><span class="line"> </span><br><span class="line">    bodyPart.boundary = self.boundary;</span><br><span class="line"> </span><br><span class="line">    bodyPart.bodyContentLength = [body length];</span><br><span class="line"> </span><br><span class="line">    bodyPart.body = body;</span><br><span class="line"> </span><br><span class="line">    [self.bodyStream appendHTTPBodyPart:bodyPart];</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>除了NSData，还可以传入NSInputStream,NSURL去构建AFHTTPBodyPart对象，过程和NSData类似，设置Content-disposition和Content-Type，再通过data去构建AFHTTPBodyPart。</p>
<h3 id="AFMultipartBodyStream"><a href="#AFMultipartBodyStream" class="headerlink" title="AFMultipartBodyStream"></a>AFMultipartBodyStream</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">- (NSInteger)read:(uint8_t *)buffer</span><br><span class="line"> </span><br><span class="line">        maxLength:(NSUInteger)length</span><br><span class="line">&#123;</span><br><span class="line">//AFStreamingMutipartFormData将AFMultipartBodyStream设置到NSUrlRequest的httpbodys</span><br><span class="line">//tream之后，foundation会自动调用read:maxLength:方法，改方法实现中遍历之前构建的所有AFHTTP</span><br><span class="line">//BodyPart对象，分别调用它们的read:maxLength:方法来获取数据。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    if ([self streamStatus] == NSStreamStatusClosed) &#123;</span><br><span class="line"> </span><br><span class="line">        return 0;</span><br><span class="line"> </span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    NSInteger totalNumberOfBytesRead = 0;</span><br><span class="line"> </span><br><span class="line">#pragma clang diagnostic push</span><br><span class="line"> </span><br><span class="line">#pragma clang diagnostic ignored &quot;-Wgnu&quot;</span><br><span class="line"> </span><br><span class="line">    while ((NSUInteger)totalNumberOfBytesRead &lt; MIN(length, self.</span><br><span class="line">        numberOfBytesInPacket)) &#123;</span><br><span class="line"> </span><br><span class="line">        if (!self.currentHTTPBodyPart || ![self.currentHTTPBodyPart </span><br><span class="line">            hasBytesAvailable]) &#123;</span><br><span class="line"> </span><br><span class="line">            if (!(self.currentHTTPBodyPart = [self.HTTPBodyPartEnumerator </span><br><span class="line">                nextObject])) &#123;</span><br><span class="line"> </span><br><span class="line">                break;</span><br><span class="line"> </span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">        &#125; else &#123;</span><br><span class="line"> </span><br><span class="line">            NSUInteger maxLength = length - (NSUInteger)totalNumberOfBytesRead;</span><br><span class="line"> </span><br><span class="line">            NSInteger numberOfBytesRead = [self.currentHTTPBodyPart read:&amp;</span><br><span class="line">            buffer[totalNumberOfBytesRead] maxLength:maxLength];</span><br><span class="line"> </span><br><span class="line">            if (numberOfBytesRead == -1) &#123;</span><br><span class="line"> </span><br><span class="line">                self.streamError = self.currentHTTPBodyPart.inputStream.</span><br><span class="line">                streamError;</span><br><span class="line"> </span><br><span class="line">                break;</span><br><span class="line"> </span><br><span class="line">            &#125; else &#123;</span><br><span class="line"> </span><br><span class="line">                totalNumberOfBytesRead += numberOfBytesRead;</span><br><span class="line"> </span><br><span class="line">                if (self.delay &gt; 0.0f) &#123;</span><br><span class="line"> </span><br><span class="line">                    [NSThread sleepForTimeInterval:self.delay];</span><br><span class="line"> </span><br><span class="line">                &#125;</span><br><span class="line"> </span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">    &#125;</span><br><span class="line">    return totalNumberOfBytesRead;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="AFHTTPBodyPart"><a href="#AFHTTPBodyPart" class="headerlink" title="AFHTTPBodyPart"></a>AFHTTPBodyPart</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">//根据body类型生成对应的inputStream</span><br><span class="line">- (NSInputStream *)inputStream &#123;</span><br><span class="line"> </span><br><span class="line">    if (!_inputStream) &#123;</span><br><span class="line"> </span><br><span class="line">        if ([self.body isKindOfClass:[NSData class]]) &#123;</span><br><span class="line"> </span><br><span class="line">            _inputStream = [NSInputStream inputStreamWithData:self.body];</span><br><span class="line"> </span><br><span class="line">        &#125; else if ([self.body isKindOfClass:[NSURL class]]) &#123;</span><br><span class="line"> </span><br><span class="line">            _inputStream = [NSInputStream inputStreamWithURL:self.body];</span><br><span class="line"> </span><br><span class="line">        &#125; else if ([self.body isKindOfClass:[NSInputStream class]]) &#123;</span><br><span class="line"> </span><br><span class="line">            _inputStream = self.body;</span><br><span class="line"> </span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            _inputStream = [NSInputStream inputStreamWithData:[NSData data]];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    return _inputStream;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">- (NSInteger)read:(uint8_t *)buffer</span><br><span class="line"> </span><br><span class="line">        maxLength:(NSUInteger)length</span><br><span class="line"> </span><br><span class="line">&#123;</span><br><span class="line"> </span><br><span class="line">    NSInteger totalNumberOfBytesRead = 0;</span><br><span class="line">    if (_phase == AFEncapsulationBoundaryPhase) &#123;</span><br><span class="line">//boundary部分，转成NSData</span><br><span class="line">        NSData *encapsulationBoundaryData = [([self hasInitialBoundary] ? </span><br><span class="line">            AFMultipartFormInitialBoundary(self.boundary) : </span><br><span class="line">            AFMultipartFormEncapsulationBoundary(self.boundary)) </span><br><span class="line">            dataUsingEncoding:self.stringEncoding];</span><br><span class="line"> </span><br><span class="line">        totalNumberOfBytesRead += [self readData:encapsulationBoundaryData </span><br><span class="line">        intoBuffer:&amp;buffer[totalNumberOfBytesRead] maxLength:(length - (</span><br><span class="line">            NSUInteger)totalNumberOfBytesRead)];</span><br><span class="line"> </span><br><span class="line">    &#125;</span><br><span class="line">    if (_phase == AFHeaderPhase) &#123;</span><br><span class="line">//content-disposition和content-length,转成NSData</span><br><span class="line">        NSData *headersData = [[self stringForHeaders] dataUsingEncoding:self.</span><br><span class="line">        stringEncoding];</span><br><span class="line"> </span><br><span class="line">        totalNumberOfBytesRead += [self readData:headersData intoBuffer:&amp;buffer</span><br><span class="line">        [totalNumberOfBytesRead] maxLength:(length - (NSUInteger)</span><br><span class="line">        totalNumberOfBytesRead)];</span><br><span class="line"> </span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    if (_phase == AFBodyPhase) &#123;</span><br><span class="line">        NSInteger numberOfBytesRead = 0;</span><br><span class="line">//每个AFHTTPBodyPart的body部分，也就是实际传输的数据部分，都通过在inputStream方法里根据其实</span><br><span class="line">//际数据类型转化成了NSInputStream类型对象，所以这里只需要调用foundation自带的read:maxLength方法就行了。</span><br><span class="line">        numberOfBytesRead = [self.inputStream read:&amp;buffer[</span><br><span class="line">        totalNumberOfBytesRead] maxLength:(length - (NSUInteger)</span><br><span class="line">        totalNumberOfBytesRead)];</span><br><span class="line"> </span><br><span class="line">        if (numberOfBytesRead == -1) &#123;</span><br><span class="line"> </span><br><span class="line">            return -1;</span><br><span class="line"> </span><br><span class="line">        &#125; else &#123;</span><br><span class="line"> </span><br><span class="line">            totalNumberOfBytesRead += numberOfBytesRead;</span><br><span class="line">            if ([self.inputStream streamStatus] &gt;= NSStreamStatusAtEnd) &#123;</span><br><span class="line"> </span><br><span class="line">                [self transitionToNextPhase];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    if (_phase == AFFinalBoundaryPhase) &#123;</span><br><span class="line">//如果当前AFHTTPBodyPart是最后一个参数，那么会比其他参数多一个--boundary--的部分,转成NSData</span><br><span class="line">        NSData *closingBoundaryData = ([self hasFinalBoundary] ? [</span><br><span class="line">            AFMultipartFormFinalBoundary(self.boundary) dataUsingEncoding:self.</span><br><span class="line">            stringEncoding] : [NSData data]);</span><br><span class="line"> </span><br><span class="line">        totalNumberOfBytesRead += [self readData:closingBoundaryData intoBuffer</span><br><span class="line">        :&amp;buffer[totalNumberOfBytesRead] maxLength:(length - (NSUInteger)</span><br><span class="line">        totalNumberOfBytesRead)];</span><br><span class="line"> </span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    return totalNumberOfBytesRead;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">//将data读入buffer中</span><br><span class="line">- (NSInteger)readData:(NSData *)data</span><br><span class="line"> </span><br><span class="line">           intoBuffer:(uint8_t *)buffer</span><br><span class="line"> </span><br><span class="line">            maxLength:(NSUInteger)length</span><br><span class="line"> </span><br><span class="line">&#123;</span><br><span class="line"> </span><br><span class="line">#pragma clang diagnostic push</span><br><span class="line"> </span><br><span class="line">#pragma clang diagnostic ignored &quot;-Wgnu&quot;</span><br><span class="line">/*没有明白为什么读data的时候range为什么要从_phaseReadOffset开始，不应该是从0开始吗，因为每次</span><br><span class="line">都是一个全新的data*/</span><br><span class="line">    NSRange range = NSMakeRange((NSUInteger)_phaseReadOffset, MIN([data length]</span><br><span class="line">     - ((NSUInteger)_phaseReadOffset), length));</span><br><span class="line">//将data中range范围之内的数据复制到buffer里</span><br><span class="line">    [data getBytes:buffer range:range];</span><br><span class="line"> </span><br><span class="line">#pragma clang diagnostic pop</span><br><span class="line"> </span><br><span class="line">    _phaseReadOffset += range.length;</span><br><span class="line"> </span><br><span class="line">    if (((NSUInteger)_phaseReadOffset) &gt;= [data length]) &#123;</span><br><span class="line"> </span><br><span class="line">        [self transitionToNextPhase];</span><br><span class="line"> </span><br><span class="line">    &#125;</span><br><span class="line">    return (NSInteger)range.length;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">//序列化AFHTTPBodyPart的headers部分</span><br><span class="line">- (NSString *)stringForHeaders &#123;</span><br><span class="line">    NSMutableString *headerString = [NSMutableString string];</span><br><span class="line"> </span><br><span class="line">    for (NSString *field in [self.headers allKeys]) &#123;</span><br><span class="line"> </span><br><span class="line">        [headerString appendString:[NSString stringWithFormat:@&quot;%@: %@%@&quot;, </span><br><span class="line">        field, [self.headers valueForKey:field], kAFMultipartFormCRLF]];</span><br><span class="line"> </span><br><span class="line">    &#125;</span><br><span class="line">    [headerString appendString:kAFMultipartFormCRLF];</span><br><span class="line">    return [NSString stringWithString:headerString];</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">//计算每个AFHTTPBodyPart的内容长度，包括传输参数，请求头和boundary信息,在AFMultiStream里会</span><br><span class="line">//将所有的AFHTTPBodyPart的content-length加起来，做为整个POST请求体的content-length。</span><br><span class="line">- (unsigned long long)contentLength &#123;</span><br><span class="line">    unsigned long long length = 0;</span><br><span class="line">//boundary</span><br><span class="line">    NSData *encapsulationBoundaryData = [([self hasInitialBoundary] ? </span><br><span class="line">        AFMultipartFormInitialBoundary(self.boundary) : </span><br><span class="line">    AFMultipartFormEncapsulationBoundary(self.boundary)) dataUsingEncoding:self</span><br><span class="line">    .stringEncoding];</span><br><span class="line">    length += [encapsulationBoundaryData length];</span><br><span class="line">//headers</span><br><span class="line">    NSData *headersData = [[self stringForHeaders] dataUsingEncoding:self.</span><br><span class="line">    stringEncoding];</span><br><span class="line">    length += [headersData length];</span><br><span class="line">//data</span><br><span class="line">    length += _bodyContentLength;</span><br><span class="line">//close boudary</span><br><span class="line">    NSData *closingBoundaryData = ([self hasFinalBoundary] ? [</span><br><span class="line">        AFMultipartFormFinalBoundary(self.boundary) dataUsingEncoding:self.</span><br><span class="line">    stringEncoding] : [NSData data]);</span><br><span class="line">    length += [closingBoundaryData length];</span><br><span class="line">    return length;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://yoursite.com/2016/10/13/AFNetworking-RequestSerializer/" data-id="cjkhxzal10005m8enwx9abhku" class="article-share-link">分享</a><div class="tags"><a href="/tags/源码分析/">源码分析</a></div><div class="post-nav"><a href="/2016/10/13/AFNetworking-ResponseSerializer/" class="pre">AFNetworking-ResponseSerializer</a><a href="/2016/01/26/CFRunLoop/" class="next">CFRunLoop</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://yoursite.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Tech/">Tech</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Tools/">Tools</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/源码分析/" style="font-size: 15px;">源码分析</a> <a href="/tags/iOS/" style="font-size: 15px;">iOS</a> <a href="/tags/git/" style="font-size: 15px;">git</a> <a href="/tags/Node/" style="font-size: 15px;">Node</a> <a href="/tags/hexo/" style="font-size: 15px;">hexo</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/01/29/布局结束监测工具/">布局结束监听工具</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/11/Node小结/">Node小结</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/02/iOS性能监控/">iOS性能监控</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/25/Method Swizzle的危机/">Method Swizzle的危机</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/25/GitHook/">Git Hook</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/19/Method Swizzle中的对象模型/">Method Swizzle中的对象模型</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/19/iOS定位库-INTULocationRequest/">iOS定位库-INTULocationRequest</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/10/13/AFNetWorking—NSURLSession/">AFNetWorking—NSURLSession</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/10/13/AFNetworking-NSURLConnection/">AFNetworking-NSURLConnection</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/10/13/AFNetworking-ResponseSerializer/">AFNetworking-ResponseSerializer</a></li></ul></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2018 <a href="/." rel="nofollow">一只独来独往的水鸟.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>
<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="博客"><title>AFNetWorking—NSURLSession | 一只独来独往的水鸟</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/6.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">AFNetWorking—NSURLSession</h1><a id="logo" href="/.">一只独来独往的水鸟</a><p class="description">iOS</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">AFNetWorking—NSURLSession</h1><div class="post-meta">Oct 13, 2016<span> | </span><span class="category"><a href="/categories/Tech/">Tech</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span></div><div class="post-content"><p>NSURLSession是iOS7推出的新一代网络框架，在NSURLConnection的基础上多了一种选择，AFNetwrking基于NSURLSession也实现了相应的网络请求API。从功能模块划分，网络可用性，数据的序列化和反序列化以及安全策略这几部分都是一样的，主要是网络请求的管理，请求和返回的处理比前者更加简单，应该说NSURLSession从系统层面实现了NSURLConnection没有实现的部分，比如管理多个请求，直接面向应用层提供上传下载的接口，所以AFNetworking基于NSRULSession实现的网络层更简单，但是功能上没有NSURLConnection那么丰富，比如监听所有任务中完成任务的进度，还有和UIKit的集成。   </p>
<h3 id="AFURLSessionManager"><a href="#AFURLSessionManager" class="headerlink" title="AFURLSessionManager"></a>AFURLSessionManager</h3><ul>
<li><p>NSURLSession<br>支持多个用task网络请求的管理，是网络层的核心。有NSURLSessionDelegate,NSURLSessionTas<br>kDelegate,NSURLSessionDataDelegate,NSURLSessionDownloadDelegate 多个代理接口。</p>
</li>
<li><p>operationQueue<br>用于初始化NSURLSession的队列，网络请求返回的回调会在该队列中的线程执行。类比使用NSURLConnection的时候，也有一个OperationQueue，功能基本一样，虽然NSURLConnection自己就是异步线程去发起网络请求，但是如果不使用NSOpeartion和OperationQueue，网络回调都将正在主线程中执行，会影响UI操作的流畅性。在NSURLConnection的实现部分，是通过全局的网络线程去执行回调的。这是NSURLConnection和NSURLSession不太一致的地方，后者是系统层就处理了，比NSURLConnection方便不少。</p>
</li>
<li><p>responseSerializer 用于返回数据的反序列化的对象</p>
</li>
<li><p>tasks  NSURLSession管理的所有网络请求包含重复的，分为一般的api请求,上传请求和下载请求。</p>
</li>
<li><p>dataTasks 一般的api请求</p>
</li>
<li><p>uploadTasks 上传请求</p>
</li>
<li><p>downloadTasks 下载请求</p>
</li>
<li><p>completionQueue 用户端的回调所在的队列</p>
</li>
<li><p>completionGroup 用户端回调队列所在的组</p>
</li>
<li><p>AFURLSessionManagerTaskDelegagate<br>在AFURLSessionManager内部用于存储task相关数据的业务对象，详细内容下面会单独介绍。</p>
</li>
<li><p>mutableTaskDelegatesKeyedByTaskIdentifier 可变字典，用于存储task和对应delegate之间的关联。</p>
<p>剩下的就是在网络请求过程中各种状态的回调block对象了。</p>
</li>
</ul>
<h3 id="AFURLSessionManagerTaskDelegate"><a href="#AFURLSessionManagerTaskDelegate" class="headerlink" title="AFURLSessionManagerTaskDelegate"></a>AFURLSessionManagerTaskDelegate</h3><p>   在网络请求的各种回调过程中，它用来存储和记录与单个task相关的信息，在网络请求完成之后，将数据<br>返回给用户端。</p>
<ul>
<li><p>AFURLSessionManager<br>在AFURLSessionManagerTaskDelegate对象中记录的session对象，一个session对象对应这多个<br>task对象，每个task都有一个与之对应的AFURLSessionManagerTaskDelegate对象。每一个task<br>在session层面都共享了一些数据，比如序列化对象，回调的队列和组，当一个task完成的时候，都需要<br>从共享的session中获取这些数据来完成业务层的回调逻辑。</p>
</li>
<li><p>mutableData<br>存储了当前请求获得的返回的数据信息，最后会反序列化成对象或者是以文件的形式保存下来。</p>
</li>
<li><p>progress<br>记录了下载或者上传文件的进度，可以随时通过uploadProgressForTask来获取某个task完成情况，<br>该方法参数为当前task。</p>
</li>
<li><p>AFURLSessionTaskCompletionHandler 由用户端设置的，task请求完成之后的用户端回调block</p>
</li>
<li><p>AFURLSessionDownloadTaskDidFinishDownloadingBlock<br>由用户端设置的，task下载文件完成之后生成目标文件的保存路径的block</p>
</li>
<li><p>downloadFileURL<br>由上一个block生成的目标文件保存路径，在下载完成的回调中设置，然后在整个请求完成的回调中以通知的形式返回给用户端</p>
</li>
</ul>
<h3 id="AFURLSessionManager_u4E0EAFURLSessionManagerTaskDelegate_u7684_u5173_u7CFB"><a href="#AFURLSessionManager_u4E0EAFURLSessionManagerTaskDelegate_u7684_u5173_u7CFB" class="headerlink" title="AFURLSessionManager与AFURLSessionManagerTaskDelegate的关系"></a>AFURLSessionManager与AFURLSessionManagerTaskDelegate的关系</h3><p>   在AFURLSessionManager中实现了大部分NSURLSession的协议，而AFURLSessionManagerTaskDelegate也实现了几个重要的协议，比如数据获取，整个task请求完成，文件下载和上传的进度。不同之处在于AFURLSessionManager是针对所有请求的，而taskDelegate只是针对某次具体的请求的。taskDelegate并没有直接从系统层获得回调，而是所有的回调都会先经过AFURLSessionManager处理，然后再分发给每个具体的taskDelegate，由每个taskDelegate自己存储并记录与当前请求相关的数据和信息。至于AFURLSessionManagerTaskDelegate中会有类似以下的回调的实现逻辑：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- (void)URLSession:(__unused NSURLSession *)session&#10; &#10;              task:(__unused NSURLSessionTask *)task&#10; &#10;   didSendBodyData:(__unused int64_t)bytesSent&#10; &#10;    totalBytesSent:(int64_t)totalBytesSent&#10; &#10;totalBytesExpectedToSend:(int64_t)totalBytesExpectedToSend&#10; &#10;&#123;&#10; &#10;    self.progress.totalUnitCount = totalBytesExpectedToSend;&#10; &#10;    self.progress.completedUnitCount = totalBytesSent;&#10; &#10;&#125;</span><br></pre></td></tr></table></figure>
<p>   task的delegate在这里只获取有用的数据，保存了上传的进度，这样做的目的就是为了保持代码一致性阅读起来更容理解，相当于代理方法的分发。sessionManager里通过字典存下了所有的task，而又在具体的session回调中去处理每个task相关的逻辑。</p>
<h3 id="AFHTTPSessionManager"><a href="#AFHTTPSessionManager" class="headerlink" title="AFHTTPSessionManager"></a>AFHTTPSessionManager</h3><p>   它继承自AFURLSessionManager，主要功能增加了一些初始化的方法以及对序列化和反序列化阶段的错误检查，还有设置具体的序列化对象。只是在AFURLSessionManager的基础上做了更容易使用的接口的封装。</p>
<h3 id="NSURLSession_u548CNSURLConnection"><a href="#NSURLSession_u548CNSURLConnection" class="headerlink" title="NSURLSession和NSURLConnection"></a>NSURLSession和NSURLConnection</h3><p>   AFNetworking中NSRULSession的实现上的设计上基本是一致的，AFURLSessionManager相当于AFHTTPRequestOperationManager。而AFURLConnectionOperation类似与NSURLSessionTask。但是对网络回调的实现上是不一致的，前者是依赖NSURLSession处理，然后分发给每个task自己处理。而NSURLConnection是每个请求都是独立处理各自来自系统层的网络回调，这是由于采用了不同的系统网络框架造成的。两种实现都有一个问题，就是如果baseURL是经常变化的，下载某一个素材的时候，这个时候比较好的办法是只使用NSRULConnection中的AFURLConnectionPeration，每次url由自己指定，自己去维护OperationQueue，可能需要自己实现AFHTTPRequestOperationManager的部分。</p>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://yoursite.com/2016/10/13/AFNetWorking—NSURLSession/" data-id="cj5jc89sc00001wcvhpp9ox1r" class="article-share-link">分享</a><div class="tags"><a href="/tags/源码分析/">源码分析</a></div><div class="post-nav"><a href="/2016/10/13/AFNetworking-NSURLConnection/" class="pre">AFNetworking-NSURLConnection</a><a href="/2016/10/13/AFNetworking-ResponseSerializer/" class="next">AFNetworking-ResponseSerializer</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://yoursite.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Tech/">Tech</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Tools/">Tools</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/源码分析/" style="font-size: 15px;">源码分析</a> <a href="/tags/hexo/" style="font-size: 15px;">hexo</a> <a href="/tags/iOS/" style="font-size: 15px;">iOS</a> <a href="/tags/git/" style="font-size: 15px;">git</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/09/12/Method Swizzle的危机/">Method Swizzle的危机</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/25/GitHook/">Git Hook</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/13/Method Swizzle中的对象模型/">Method Swizzle中的对象模型</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/19/iOS定位库-INTULocationRequest/">iOS定位库-INTULocationRequest</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/10/13/AFNetworking-NSURLConnection/">AFNetworking-NSURLConnection</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/10/13/AFNetWorking—NSURLSession/">AFNetWorking—NSURLSession</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/10/13/AFNetworking-ResponseSerializer/">AFNetworking-ResponseSerializer</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/10/13/AFNetworking-RequestSerializer/">AFNetworking-RequestSerializer</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/26/CFRunLoop/">CFRunLoop</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/26/RunLoop介绍/">RunLoop介绍</a></li></ul></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2017 <a href="/." rel="nofollow">一只独来独往的水鸟.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>